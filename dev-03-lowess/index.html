
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.2">
    
    
      
        <title>LOWESS - Merit-Order-Effect</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.73f7c429.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.39b8e14a.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lowess" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Merit-Order-Effect" class="md-header-nav__button md-logo" aria-label="Merit-Order-Effect">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Merit-Order-Effect
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              LOWESS
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/AyrtonB/Merit-Order-Effect/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    AyrtonB/Merit-Order-Effect
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../ug-08-lowess-quick-start/" class="md-tabs__link">
        User Guide
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../ug-01-hydro-seasonality/" class="md-tabs__link">
        Examples
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../dev-01-retrieval/" class="md-tabs__link md-tabs__link--active">
        Development
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Merit-Order-Effect" class="md-nav__button md-logo" aria-label="Merit-Order-Effect">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Merit-Order-Effect
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/AyrtonB/Merit-Order-Effect/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    AyrtonB/Merit-Order-Effect
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" >
    
    <label class="md-nav__link" for="nav-2">
      User Guide
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="User Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-08-lowess-quick-start/" class="md-nav__link">
      LOWESS Quick-Start
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-05-data-retrieval/" class="md-nav__link">
      Data Retrieval
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-06-surface-estimation/" class="md-nav__link">
      Surface Estimation
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-07-moe-quantification/" class="md-nav__link">
      MOE Quantification
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
    
    <label class="md-nav__link" for="nav-3">
      Examples
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Examples" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-01-hydro-seasonality/" class="md-nav__link">
      Hydro Seasonality
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-02-ligo/" class="md-nav__link">
      LIGO
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-03-power-curve/" class="md-nav__link">
      Power Curve
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-04-electricity-prices/" class="md-nav__link">
      Electricity Prices
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  


  
  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Development
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Development" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Development
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-01-retrieval/" class="md-nav__link">
      Data Retrieval
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-02-eda/" class="md-nav__link">
      Exploratory Data Analysis
    </a>
  </li>

        
          
          
          


  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        LOWESS
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      LOWESS
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    Imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lowess-development" class="md-nav__link">
    LOWESS Development
  </a>
  
    <nav class="md-nav" aria-label="LOWESS Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#weights" class="md-nav__link">
    Weights
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regression" class="md-nav__link">
    Regression
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lowess-on-real-world-data" class="md-nav__link">
    LOWESS on Real-World Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#robust-regression" class="md-nav__link">
    Robust Regression
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#confidence-intervals" class="md-nav__link">
    Confidence Intervals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quantile-predictions" class="md-nav__link">
    Quantile Predictions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#external-weights" class="md-nav__link">
    External Weights
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-04-price-surface-estimation/" class="md-nav__link">
      Price Curve Estimation
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-05-price-moe/" class="md-nav__link">
      Price MOE Calculation
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-06-carbon-surface-estimation-and-moe/" class="md-nav__link">
      Carbon Curve Estimation & MOE
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-07-prediction-confidence-and-intervals/" class="md-nav__link">
      Prediction & Confidence Intervals
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-08-hyper-parameter-tuning/" class="md-nav__link">
      Hyper-Parameter Tuning
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-09-tables-and-figures/" class="md-nav__link">
      Tables & Figures
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-10-ci-cd/" class="md-nav__link">
      CI-CD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    Imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lowess-development" class="md-nav__link">
    LOWESS Development
  </a>
  
    <nav class="md-nav" aria-label="LOWESS Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#weights" class="md-nav__link">
    Weights
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regression" class="md-nav__link">
    Regression
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lowess-on-real-world-data" class="md-nav__link">
    LOWESS on Real-World Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#robust-regression" class="md-nav__link">
    Robust Regression
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#confidence-intervals" class="md-nav__link">
    Confidence Intervals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quantile-predictions" class="md-nav__link">
    Quantile Predictions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#external-weights" class="md-nav__link">
    External Weights
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/AyrtonB/Merit-Order-Effect/edit/main/docs/dev-03-lowess.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="lowess">Lowess<a class="headerlink" href="#lowess" title="Permanent link">&para;</a></h1>
<p><a href="https://notebooks.gesis.org/binder/v2/gh/AyrtonB/Merit-Order-Effect/main?filepath=nbs%2Fdev-03-lowess.ipynb"><img alt="Binder" src="https://notebooks.gesis.org/binder/badge_logo.svg" /></a></p>
<p>Outlines the development of the Scikit-Learn compatible <code>Lowess</code> model, as well as its extension <code>LowessDates</code> used for time-adaptive LOWESS regression. Included are functions for extending both models to generate prediction and confidence intervals. </p>
<p>The original LOWESS code written by W. S. Cleveland can be found <a href="https://www.netlib.org/go/lowess">here</a></p>
<p><br></p>
<h3 id="imports">Imports<a class="headerlink" href="#imports" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>

<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">linalg</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">timeit</span>
<span class="kn">from</span> <span class="nn">moepy</span> <span class="kn">import</span> <span class="n">eda</span>
</code></pre></div>
<p><br></p>
<h3 id="lowess-development">LOWESS Development<a class="headerlink" href="#lowess-development" title="Permanent link">&para;</a></h3>
<p>Before we go ahead any further we'll create some sample data for fitting and also define the fraction of the data over which we'll do the localised regression.</p>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">frac</span> <span class="o">=</span> <span class="mf">0.5</span>
</code></pre></div>
<p><br></p>
<p>We can see that we've just created a simple sin curve</p>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[&lt;matplotlib.lines.Line2D at 0x2bbf1599b50&gt;]
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_7_output_1.png" /></p>
<p><br></p>
<h4 id="weights">Weights<a class="headerlink" href="#weights" title="Permanent link">&para;</a></h4>
<p>In order to do localised regression we need to know what points are local, for this reason we'll start by creating a function for calculating the distance between one point and all of the other points</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="n">get_dist</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dist</span> <span class="o">=</span> <span class="n">get_dist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">dist</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([0. , 0.2, 0.4, 0.6, 0.8, 1. , 1.2, 1.4, 1.6, 1.8, 2. , 2.2, 2.4,
       2.6, 2.8, 3. , 3.2, 3.4, 3.6, 3.8, 4. , 4.2, 4.4, 4.6, 4.8, 5. ])
</code></pre></div>
<p><br></p>
<p>We've defined our selection of local based on the fraction of surrounding data, this means we need to calculate the distance around any given point that contains the fraction of data specified</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">get_dist_threshold</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identifies the minimum distance that contains the desired data fraction&quot;&quot;&quot;</span>
    <span class="n">frac_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">*</span><span class="n">frac</span><span class="p">))</span>
    <span class="n">dist_threshold</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="n">frac_idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">dist_threshold</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dist_threshold</span> <span class="o">=</span> <span class="n">get_dist_threshold</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">)</span>

<span class="n">dist_threshold</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2.6
</code></pre></div>
<p><br>
We'll now define a function that will map from the distances to their relative weights according to a tricube kernel</p>
<div class="arithmatex">\[
\begin{equation}
  \label{eqn:tricube_kernel}
    w(x) = \left\{ 
    \begin{array}{ll}
    (1 - |x|^3)^3 &amp; \mbox{for $|x| &lt; 1$}    \\
    0             &amp; \mbox{for $|x| \geq 1$}
    \end{array}
    \right.
\end{equation}
\]</div>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="n">dist_to_weights</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">dist</span><span class="p">,</span> <span class="n">dist_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">/</span><span class="n">dist_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">))</span> <span class="o">**</span> <span class="mi">3</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dist_threshold</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">dist_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">weights_sample</span> <span class="o">=</span> <span class="n">dist_to_weights</span><span class="p">(</span><span class="n">dist_sample</span><span class="p">,</span> <span class="n">dist_threshold</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dist_sample</span><span class="p">,</span> <span class="n">weights_sample</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Distance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Weight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">dist_sample</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(0.0, 1.1)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_16_output_1.png" /></p>
<p><br></p>
<p>We can now use the distance matrix and threshold to create a vector of the relative weights of all data points for the local regression at a specified location</p>
<div class="highlight"><pre><span></span><code><span class="n">weights</span> <span class="o">=</span> <span class="n">dist_to_weights</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">dist_threshold</span><span class="p">)</span>

<span class="n">weights</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([1.        , 0.99980801, 0.99846479, 0.99482495, 0.98776226,
       0.97619149, 0.95909867, 0.93557909, 0.90488204, 0.86646079,
       0.82002586, 0.76559882, 0.70356317, 0.63470792, 0.56025877,
       0.4818903 , 0.40171203, 0.32221935, 0.24619951, 0.17658114,
       0.11621427, 0.06756635, 0.03231788, 0.01083964, 0.00153137,
       0.        ])
</code></pre></div>
<p><br></p>
<p>We'll wrap these steps into a single function and see how long it takes to compute</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the weightings at each data point for a single localised regression&quot;&quot;&quot;</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">get_dist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
    <span class="n">dist_threshold</span> <span class="o">=</span> <span class="n">get_dist_threshold</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">dist_to_weights</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">dist_threshold</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weights</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">get_weights</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.3881793
</code></pre></div>
<p><br></p>
<p>We've successfully calculated the weights with respect to a single point but we need to repeat this across each of value locations in our dataset.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">get_all_weights</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the weightings at each data point for a LOWESS regression&quot;&quot;&quot;</span>
    <span class="n">all_weights</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">get_weights</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">)</span>
        <span class="n">all_weights</span> <span class="o">+=</span> <span class="p">[</span><span class="n">weights</span><span class="p">]</span>

    <span class="n">all_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_weights</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_weights</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">all_weights</span> <span class="o">=</span> <span class="n">get_all_weights</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">)</span>

<span class="n">all_weights</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[1.        , 0.99863512, 0.98911574, 0.96358278, 0.91512916],
       [0.99826489, 1.        , 0.99826489, 0.98617531, 0.95385361],
       [0.98207661, 0.99774775, 1.        , 0.99774775, 0.98207661],
       [0.92116732, 0.97619149, 0.997003  , 1.        , 0.997003  ],
       [0.75907091, 0.89295331, 0.96743815, 0.99589042, 1.        ]])
</code></pre></div>
<p><br></p>
<p>Not too bad at all, we could now use this to weight the fitting of the polynomials in the LOWESS. However, we've carried out most of these operations as part of for loops over vectors, what if we could store our data in matrices and do single operations over them?</p>
<p>Thankfully Numpy has lots of helpful functions to aid us in this. We'll start by creating a matrix with the distances, to do this we can reshape the vectors into matrices of shape (25, 1) and (1, 25), then deduct the matrix with only one row from the matrix with only one column.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="n">vector_to_dist_matrix</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">vector_to_dist_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="s1">&#39;Distance&#39;</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Data Point&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Regression Nodes&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(69.58333333333334, 0.5, &#39;Regression Nodes&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_27_output_1.png" /></p>
<p><br></p>
<p>This approach brings an order of magnitude speed-up to the operation</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="n">get_dist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">x_idx</span><span class="p">])</span> <span class="k">for</span> <span class="n">x_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))],</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>885 ms Â± 107 ms per loop (mean Â± std. dev. of 7 runs, 1 loop each)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">vector_to_dist_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>122 ms Â± 11.6 ms per loop (mean Â± std. dev. of 7 runs, 10 loops each)
</code></pre></div>
<p><br></p>
<p>Now we need to calculate the distance threshold (max distance away from point of interest that is within the data fraction specified). </p>
<p><a href="https://gist.github.com/agramfort/850437">Alexandre Gramfort</a> lays out one approach to determine the distances using a list comprehension.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="n">get_frac_idx</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">frac</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">gramfort_get_dist_thresholds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">frac_idx</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]))[</span><span class="n">frac_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>

<span class="n">frac_idx</span> <span class="o">=</span> <span class="n">get_frac_idx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>

<span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">gramfort_get_dist_thresholds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac_idx</span><span class="p">),</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2.5025440000000003
</code></pre></div>
<p><br></p>
<p>Pretty quick, lets see if we could do better though. </p>
<p>We'll try keeping the distance matrix intact rather than breaking it up in each iteration. This enables us to do the absolute conversion, sorting and indexing over a matrix rather than looping the operations over vectors. </p>
<p>These changes gave us an order of magnitude speed-up.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="n">get_dist_thresholds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">frac_idx</span><span class="p">,</span> <span class="n">dist_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">)[:,</span> <span class="n">frac_idx</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dist_thresholds</span> <span class="o">=</span> <span class="n">get_dist_thresholds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac_idx</span><span class="p">,</span> <span class="n">dist_matrix</span><span class="p">)</span>

<span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">get_dist_thresholds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac_idx</span><span class="p">,</span> <span class="n">dist_matrix</span><span class="p">),</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.12421600000000055
</code></pre></div>
<p><br></p>
<p>Now we have both the distance matrix and thresholds we can start to calculate the weightings, the first step to this is scale and clip the distances based on their threshold values.</p>
<div class="highlight"><pre><span></span><code><span class="n">inv_linear_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">dist_matrix</span><span class="o">/</span><span class="n">dist_thresholds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">inv_linear_weights</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[0.        , 0.08333333, 0.16666667, 0.25      , 0.33333333],
       [0.09090909, 0.        , 0.09090909, 0.18181818, 0.27272727],
       [0.2       , 0.1       , 0.        , 0.1       , 0.2       ],
       [0.33333333, 0.22222222, 0.11111111, 0.        , 0.11111111],
       [0.5       , 0.375     , 0.25      , 0.125     , 0.        ]])
</code></pre></div>
<p><br></p>
<p>We can now calculate the tri-cubic weighting. We repeat this using both base Python and Numpy to see which is faster, surprisingly base Python comes out on top.</p>
<div class="highlight"><pre><span></span><code><span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">inv_linear_weights</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.5055094999999987
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">inv_linear_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.6110422
</code></pre></div>
<p><br></p>
<p>After a little more exploration it appears that Numpy's <i>power</i> function only offers improvements over base Python when the exponent is very high. For a good discussion on why this is the case you can read more <a href="">here</a>.</p>
<div class="highlight"><pre><span></span><code><span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">inv_linear_weights</span> <span class="o">**</span> <span class="mi">50000</span><span class="p">)</span> <span class="o">**</span> <span class="mi">50000</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.5175592999999985
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">inv_linear_weights</span><span class="p">,</span> <span class="mi">50000</span><span class="p">),</span> <span class="mi">50000</span><span class="p">),</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.5056613999999975
</code></pre></div>
<p><br></p>
<p>We'll now wrap these two steps up into a single function</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">clean_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Normalises each models weightings and removes non-finite values&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">/</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># We&#39;ll then normalise the weights so that for each model they sum to 1 for a single data point</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="c1"># And remove any non-finite values</span>

    <span class="k">return</span> <span class="n">weights</span>

<span class="k">def</span> <span class="nf">dist_2_weights_matrix</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">dist_thresholds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts distance matrix and thresholds to weightings&quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">dist_to_weights</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">dist_thresholds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">clean_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weights</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">weights</span> <span class="o">=</span> <span class="n">dist_2_weights_matrix</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">dist_thresholds</span><span class="p">)</span>

<span class="n">weights</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[0.20861363, 0.18398963, 0.16064453, 0.13720751, 0.11473407],
       [0.20814378, 0.18430943, 0.16252964, 0.14126726, 0.12082652],
       [0.20364685, 0.18375705, 0.16289653, 0.14341436, 0.1254292 ],
       [0.18628223, 0.17830797, 0.16222709, 0.14384546, 0.12796029],
       [0.13975483, 0.15666172, 0.15537944, 0.14300426, 0.12848832]])
</code></pre></div>
<p><br></p>
<p>And then combine them with the creation of the distance matrix and threshold</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">get_full_dataset_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for calculating weights from the raw data and LOWESS fraction&quot;&quot;&quot;</span>
    <span class="n">frac_idx</span> <span class="o">=</span> <span class="n">get_frac_idx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>

    <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">vector_to_dist_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">dist_thresholds</span> <span class="o">=</span> <span class="n">get_dist_thresholds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac_idx</span><span class="p">,</span> <span class="n">dist_matrix</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">dist_2_weights_matrix</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">dist_thresholds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weights</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">weights</span> <span class="o">=</span> <span class="n">get_full_dataset_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<p>We'll do a quick visual check to see if they look reasonable</p>
<div class="highlight"><pre><span></span><code><span class="n">weights</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[0.20861363, 0.18398963, 0.16064453, 0.13720751, 0.11473407],
       [0.20814378, 0.18430943, 0.16252964, 0.14126726, 0.12082652],
       [0.20364685, 0.18375705, 0.16289653, 0.14341436, 0.1254292 ],
       [0.18628223, 0.17830797, 0.16222709, 0.14384546, 0.12796029],
       [0.13975483, 0.15666172, 0.15537944, 0.14300426, 0.12848832]])
</code></pre></div>
<p><br></p>
<p>Looks good, we'll also time it</p>
<div class="highlight"><pre><span></span><code><span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">get_full_dataset_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">),</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>1.8022471000000024
</code></pre></div>
<p><br></p>
<p>Currently we have created a weights matrix that scales in size as the square of the dataset length, this could quickly become prohibitively computationally expensive for large datasets.</p>
<p>Instead we'll create a new function that lets us either specify a vector of locations (<code>reg_anchors</code>) where the regressions will be centered, or alternatively if <code>num_fits</code> is passed that will be the number of local regressions.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="n">num_fits_2_reg_anchors</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">num_fits</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">num</span><span class="o">=</span><span class="n">num_fits</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_weighting_locs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;Identifies the weighting locations for the provided dataset&quot;&quot;&quot;</span>
    <span class="n">num_type_2_dist_rows</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">num_fits</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nb">int</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">num_fits</span><span class="p">:</span> <span class="n">num_fits_2_reg_anchors</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_fits</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">reg_anchors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weighting_locs</span> <span class="o">=</span> <span class="n">num_type_2_dist_rows</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">num_fits</span><span class="p">)](</span><span class="n">x</span><span class="p">,</span> <span class="n">num_fits</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weighting_locs</span> <span class="o">=</span> <span class="n">reg_anchors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weighting_locs</span>

<span class="k">def</span> <span class="nf">create_dist_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;Constructs the distance matrix for the desired weighting locations&quot;&quot;&quot;</span>
    <span class="n">weighting_locs</span> <span class="o">=</span> <span class="n">get_weighting_locs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">reg_anchors</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="n">num_fits</span><span class="p">)</span>
    <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">weighting_locs</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dist_matrix</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">create_dist_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">dist_matrix</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(26, 26)
</code></pre></div>
<p><br></p>
<p>When neither <code>reg_anchors</code> nor <code>num_fits</code> are passed it defaults to using all data-points in the matrix which can be seen below</p>
<div class="highlight"><pre><span></span><code><span class="n">dist_thresholds</span> <span class="o">=</span> <span class="n">get_dist_thresholds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac_idx</span><span class="p">,</span> <span class="n">dist_matrix</span><span class="p">)</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">dist_2_weights_matrix</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">dist_thresholds</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="s1">&#39;Weights&#39;</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Data Point&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Regression Nodes&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(69.58333333333334, 0.5, &#39;Regression Nodes&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_59_output_1.png" /></p>
<p><br></p>
<p>However if we specify <code>num_fits</code> as 10 we can see that only 10 regression nodes are defined in the weights matrix</p>
<div class="highlight"><pre><span></span><code><span class="n">num_fits</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">create_dist_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="n">num_fits</span><span class="p">)</span>
<span class="n">dist_thresholds</span> <span class="o">=</span> <span class="n">get_dist_thresholds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac_idx</span><span class="p">,</span> <span class="n">dist_matrix</span><span class="p">)</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">dist_2_weights_matrix</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">dist_thresholds</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="s1">&#39;Weights&#39;</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Data Point&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Regression Nodes&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(69.58333333333334, 0.5, &#39;Regression Nodes&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_61_output_1.png" /></p>
<p><br></p>
<p>But what about if you were only really interested in getting highly localised regressions for a specific part of your variable space? Using the reg_anchors variable we can now specify our own grid over which to carry out the regressions.</p>
<div class="highlight"><pre><span></span><code><span class="n">reg_anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

<span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">create_dist_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">reg_anchors</span><span class="p">)</span>
<span class="n">dist_thresholds</span> <span class="o">=</span> <span class="n">get_dist_thresholds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac_idx</span><span class="p">,</span> <span class="n">dist_matrix</span><span class="p">)</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">dist_2_weights_matrix</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">dist_thresholds</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="s1">&#39;Weights&#39;</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Data Point&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Regression Nodes&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(69.58333333333334, 0.5, &#39;Regression Nodes&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_63_output_1.png" /></p>
<p><br></p>
<p>We'll wrap these steps up in a couple of functions and add in some syntactic sugar to allow the user to more flexibily specify the distance matrix kwargs</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">get_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">weighting_locs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for calculating weights from the raw data and LOWESS fraction&quot;&quot;&quot;</span>
    <span class="n">frac_idx</span> <span class="o">=</span> <span class="n">get_frac_idx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weighting_locs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">weighting_locs</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">create_dist_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">reg_anchors</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="n">num_fits</span><span class="p">)</span>

    <span class="n">dist_thresholds</span> <span class="o">=</span> <span class="n">get_dist_thresholds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac_idx</span><span class="p">,</span> <span class="n">dist_matrix</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">dist_2_weights_matrix</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">dist_thresholds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weights</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">reg_anchors</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="s1">&#39;Weights&#39;</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Data Point&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Regression Nodes&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(69.58333333333334, 0.5, &#39;Regression Nodes&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_66_output_1.png" /></p>
<p><br></p>
<p>We'll check this still works when we want to carry out a LOWESS fit over all points</p>
<div class="highlight"><pre><span></span><code><span class="n">weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="s1">&#39;Weights&#39;</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Data Point&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Regression Nodes&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(26, 26)





Text(69.58333333333334, 0.5, &#39;Regression Nodes&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_68_output_2.png" /></p>
<p><br></p>
<h4 id="regression">Regression<a class="headerlink" href="#regression" title="Permanent link">&para;</a></h4>
<p>Now that we've calculated the weightings necessary for local regression we need to create the regression functions. We'll start by calculating the intercept and gradient of a linear regression fit with optional weighting.</p>
<p>N.b. This section of the code was heavily inspired by <a href="https://gist.github.com/agramfort/850437">this gist</a> created by <a href="https://gist.github.com/agramfort">Alexandere Gramfort</a></p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">calc_lin_reg_betas</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the intercept and gradient for the specified local regressions&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">x</span><span class="p">)])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">x</span><span class="p">)],</span>
                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)]])</span>

    <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">betas</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">intercept</span><span class="p">,</span> <span class="n">gradient</span> <span class="o">=</span> <span class="n">calc_lin_reg_betas</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="n">intercept</span><span class="o">+</span><span class="n">gradient</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">intercept</span><span class="o">+</span><span class="n">gradient</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Linear Regression&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_71_output_0.png" /></p>
<p><br></p>
<p>We'll now repeat the regression calculation but will also specify a weighting for each data-point</p>
<div class="highlight"><pre><span></span><code><span class="n">row_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">intercept</span><span class="p">,</span> <span class="n">gradient</span> <span class="o">=</span> <span class="n">calc_lin_reg_betas</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">row_weights</span><span class="p">)</span>

<span class="n">x_used</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">row_weights</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
<span class="n">y_used</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">row_weights</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
<span class="n">x_weights</span> <span class="o">=</span> <span class="n">row_weights</span><span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">row_weights</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">## Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">weighted_points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="n">row_weights</span><span class="p">)</span><span class="o">*</span><span class="mi">300</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">row_weights</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray_r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Points Used&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">weighted_points</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Point Weighting&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="n">intercept</span><span class="o">+</span><span class="n">gradient</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">intercept</span><span class="o">+</span><span class="n">gradient</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Linear Regression&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../img/LOWESS_single_regression_example.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_73_output_0.png" /></p>
<p><br></p>
<p>We can repeat this for all data-points, the error being minimized across these regressions is shown in the equation below</p>
<div class="arithmatex">\[
\begin{equation}
  \label{eqn:lowess_err}
  n^{-1} \sum_{i=1}^{n} W_{k i}(x)\left(y_{i}-\sum_{j=0}^{p} \beta_{j} x^{j}\right)^{2}
\end{equation}
\]</div>
<div class="highlight"><pre><span></span><code><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">row_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">betas</span> <span class="o">=</span> <span class="n">calc_lin_reg_betas</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

    <span class="n">y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">betas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">betas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LOWESS&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x2bbf235e490&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_75_output_1.png" /></p>
<p><br></p>
<p>Whilst this fit doesn't look great remember we can reduce the fraction of data used in each fit to get a more localised regression, in this example we'll also make use of the <code>num_fits</code> parameter to reduce the number of computations that are run.</p>
<div class="highlight"><pre><span></span><code><span class="n">num_fits</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="n">num_fits</span><span class="p">)</span>

<span class="n">x_pred</span> <span class="o">=</span> <span class="n">num_fits_2_reg_anchors</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_fits</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_pred</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)):</span>
    <span class="n">row_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">betas</span> <span class="o">=</span> <span class="n">calc_lin_reg_betas</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">row_weights</span><span class="p">)</span>

    <span class="n">y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">betas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">betas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LOWESS&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x2bbf23c6280&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_77_output_1.png" /></p>
<p><br></p>
<p>Rather than  carrying out the regression fitting and prediction together we'll seperate them to add some flexibility, for example we wouldnt be able to make predictions with a specified number of polynomial fits using the code we just wrote. </p>
<p>For this fitting function we'll introduce a design matrix which will hold the coefficients for all of our regressions. We'll also make the function used for regression a parameter, this will allow us to replace it with other regression functions (e.g. polynomials) later on.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="n">check_array</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">array</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">array</span>

<span class="k">def</span> <span class="nf">fit_regressions</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_func</span><span class="o">=</span><span class="n">calc_lin_reg_betas</span><span class="p">,</span> <span class="n">num_coef</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">reg_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the design matrix for the specified local regressions&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">num_coef</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">design_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">reg_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="o">**</span><span class="n">reg_params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">design_matrix</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">fit_regressions</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

<span class="n">design_matrix</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[ 0.05905438,  0.73999059],
       [ 0.08020775,  0.6991559 ],
       [ 0.35324949,  0.41467757],
       [ 1.09720376, -0.10762239],
       [ 2.03581046, -0.58348682],
       [ 2.77888971, -0.88141726],
       [ 2.91594092, -0.92733431],
       [ 2.05244287, -0.68647646],
       [ 0.84017439, -0.38519789],
       [ 0.6033549 , -0.33232683]])
</code></pre></div>
<p><br></p>
<p>We can use this design matrix to create predictions for every local regression, then combine them based on their weightings</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fits and predicts smoothed local regressions at the specified locations&quot;&quot;&quot;</span>
    <span class="n">weighting_locs</span> <span class="o">=</span> <span class="n">get_weighting_locs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">reg_anchors</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="n">num_fits</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">weighting_locs</span><span class="o">=</span><span class="n">weighting_locs</span><span class="p">)</span>
    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">fit_regressions</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x_pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_pred</span> <span class="o">=</span> <span class="n">x</span>

    <span class="n">point_evals</span> <span class="o">=</span> <span class="n">design_matrix</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">design_matrix</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">pred_weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">weighting_locs</span><span class="p">)</span>

    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">pred_weights</span><span class="p">,</span> <span class="n">point_evals</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y_pred</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LOWESS&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x2bbf242ae50&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_83_output_1.png" /></p>
<p><br></p>
<p>If we pass an array to the <code>x_pred</code> parameter then those values will be used as the locations of the output predictions</p>
<div class="highlight"><pre><span></span><code><span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LOESS&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x2bbf24905b0&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_85_output_1.png" /></p>
<p><br></p>
<p>Lets do some time tests, starting with a small dataset</p>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>3.2 ms Â± 398 Âµs per loop (mean Â± std. dev. of 7 runs, 100 loops each)
</code></pre></div>
<p><br></p>
<p>Even with larger datasets it remains performant</p>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">frac</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># to avoid divide by zero in MAPE calc</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>1.39 s Â± 160 ms per loop (mean Â± std. dev. of 7 runs, 1 loop each)
</code></pre></div>
<p><br></p>
<p>When making predictions with large datasets and low fractions we can achieve low error for the simple sin curve fitting example</p>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MAPE: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_true</span><span class="o">-</span><span class="n">y_pred</span><span class="p">)</span><span class="o">/</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>MAPE: 0.084%
</code></pre></div>
<p><br></p>
<h4 id="lowess-on-real-world-data">LOWESS on Real-World Data<a class="headerlink" href="#lowess-on-real-world-data" title="Permanent link">&para;</a></h4>
<p>We'll now evaluate the LOWESS fit on some real data, we'll start by loading the electric insights dataset</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">df_EI</span> <span class="o">=</span> <span class="n">eda</span><span class="o">.</span><span class="n">load_EI_df</span><span class="p">(</span><span class="s1">&#39;../data/raw/electric_insights.csv&#39;</span><span class="p">)</span>

<span class="n">df_EI</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 3.12 s
</code></pre></div>
<table>
<thead>
<tr>
<th align="left">local_datetime</th>
<th align="right">day_ahead_price</th>
<th align="right">SP</th>
<th align="right">imbalance_price</th>
<th align="right">valueSum</th>
<th align="right">temperature</th>
<th align="right">TCO2_per_h</th>
<th align="right">gCO2_per_kWh</th>
<th align="right">nuclear</th>
<th align="right">biomass</th>
<th align="right">coal</th>
<th align="left">...</th>
<th align="right">demand</th>
<th align="right">pumped_storage</th>
<th align="right">wind_onshore</th>
<th align="right">wind_offshore</th>
<th align="right">belgian</th>
<th align="right">dutch</th>
<th align="right">french</th>
<th align="right">ireland</th>
<th align="right">northern_ireland</th>
<th align="right">irish</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">2009-01-01 00:00:00+00:00</td>
<td align="right">58.05</td>
<td align="right">1</td>
<td align="right">74.74</td>
<td align="right">74.74</td>
<td align="right">-0.6</td>
<td align="right">21278</td>
<td align="right">555</td>
<td align="right">6.973</td>
<td align="right">0</td>
<td align="right">17.65</td>
<td align="left">...</td>
<td align="right">38.329</td>
<td align="right">-0.404</td>
<td align="right">nan</td>
<td align="right">nan</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1.977</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">-0.161</td>
</tr>
<tr>
<td align="left">2009-01-01 00:30:00+00:00</td>
<td align="right">56.33</td>
<td align="right">2</td>
<td align="right">74.89</td>
<td align="right">74.89</td>
<td align="right">-0.6</td>
<td align="right">21442</td>
<td align="right">558</td>
<td align="right">6.968</td>
<td align="right">0</td>
<td align="right">17.77</td>
<td align="left">...</td>
<td align="right">38.461</td>
<td align="right">-0.527</td>
<td align="right">nan</td>
<td align="right">nan</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1.977</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">-0.16</td>
</tr>
<tr>
<td align="left">2009-01-01 01:00:00+00:00</td>
<td align="right">52.98</td>
<td align="right">3</td>
<td align="right">76.41</td>
<td align="right">76.41</td>
<td align="right">-0.6</td>
<td align="right">21614</td>
<td align="right">569</td>
<td align="right">6.97</td>
<td align="right">0</td>
<td align="right">18.07</td>
<td align="left">...</td>
<td align="right">37.986</td>
<td align="right">-1.018</td>
<td align="right">nan</td>
<td align="right">nan</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1.977</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">-0.16</td>
</tr>
<tr>
<td align="left">2009-01-01 01:30:00+00:00</td>
<td align="right">50.39</td>
<td align="right">4</td>
<td align="right">37.73</td>
<td align="right">37.73</td>
<td align="right">-0.6</td>
<td align="right">21320</td>
<td align="right">578</td>
<td align="right">6.969</td>
<td align="right">0</td>
<td align="right">18.022</td>
<td align="left">...</td>
<td align="right">36.864</td>
<td align="right">-1.269</td>
<td align="right">nan</td>
<td align="right">nan</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1.746</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">-0.16</td>
</tr>
<tr>
<td align="left">2009-01-01 02:00:00+00:00</td>
<td align="right">48.7</td>
<td align="right">5</td>
<td align="right">59</td>
<td align="right">59</td>
<td align="right">-0.6</td>
<td align="right">21160</td>
<td align="right">585</td>
<td align="right">6.96</td>
<td align="right">0</td>
<td align="right">17.998</td>
<td align="left">...</td>
<td align="right">36.18</td>
<td align="right">-1.566</td>
<td align="right">nan</td>
<td align="right">nan</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1.73</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">-0.16</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>We'll start by extracting the X and y data</p>
<div class="highlight"><pre><span></span><code><span class="n">y_col</span> <span class="o">=</span> <span class="s1">&#39;day_ahead_price&#39;</span>
<span class="n">X_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span>

<span class="n">yX</span> <span class="o">=</span> <span class="n">df_EI</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">:][[</span><span class="n">y_col</span><span class="p">]</span><span class="o">+</span><span class="n">X_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">yX</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">yX</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(17435,) (17435, 1)
</code></pre></div>
<p><br></p>
<p>We'll then fit the model and make the prediction</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 140 ms
</code></pre></div>
<p><br></p>
<p>And now we can plot the results!</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">55</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Demand (GW)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Day-Ahead Price (Â£/MWh)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0, 0.5, &#39;Day-Ahead Price (Â£/MWh)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_101_output_1.png" /></p>
<p><br></p>
<h4 id="robust-regression">Robust Regression<a class="headerlink" href="#robust-regression" title="Permanent link">&para;</a></h4>
<p>What we've done so far is ultimately nothing more than an extension of linear regression, which has been achieved by fitting multiple regressions and manipulating the weighting of the data points used in each one.</p>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[&lt;matplotlib.lines.Line2D at 0x2bb804d4880&gt;]
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_103_output_1.png" /></p>
<p><br></p>
<p>But we can also do much more with the weights, including adjusting them to make our regression more robust against outliers. First we'll create a new dataset which has some noise.</p>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y_noisy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span><span class="o">/</span><span class="mi">10</span>

<span class="n">y_noisy</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">y_noisy</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
<span class="n">y_noisy</span><span class="p">[</span><span class="mi">75</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;With Noise&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x2bbf17eda30&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_105_output_1.png" /></p>
<p><br></p>
<p>We can use our <code>lowess_fit_and_predict</code> function to make a lowess model of this data</p>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LOWESS&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;With Noise&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x2bbf164cd60&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_107_output_1.png" /></p>
<p><br></p>
<p>The issue though is that our model is being highly skewed by the outliers present in the data, robust regression provides a method to handle this (some improvements can also be made by increasing the <code>frac</code> value). To carry it out we need to repeat the lowess fit, but when we do we must further weight the data-points to minimize the influence of outliers.</p>
<blockquote>
<p>Robust regression is an iterative procedure that seeks to identify outliers and minimize their impact on the coefficient estimates - <a href="https://ncss-wpengine.netdna-ssl.com/wp-content/themes/ncss/pdf/Procedures/NCSS/Robust_Regression.pdf">NCSS</a>
Cleveland, W. S. (1979) in his paper 'Robust Locally Weighted Regression and Smoothing Scatterplots' outlines a procedure for carrying out robust lowess regression that we will use here.</p>
</blockquote>
<p>We'll start by calculating the standard deviation of the residuals.</p>
<div class="highlight"><pre><span></span><code><span class="n">residuals</span> <span class="o">=</span> <span class="n">y_noisy</span> <span class="o">-</span> <span class="n">y_pred</span>
<span class="n">std_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">residuals</span><span class="p">),</span> <span class="mf">0.682</span><span class="p">)</span>

<span class="n">std_dev</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.11416089877901764
</code></pre></div>
<p><br></p>
<p>We can then define a threshold, say 6 standard deviations, and clip any values outside of that. We're left with a cleaned version of the residuals.</p>
<div class="highlight"><pre><span></span><code><span class="n">max_std_dev</span> <span class="o">=</span> <span class="mi">6</span>

<span class="n">cleaned_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">residuals</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_std_dev</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">cleaned_residuals</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cleaned Residuals&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_111_output_0.png" /></p>
<p><br></p>
<p>In the last step we clipped all of our values from -1 to +1, that means if we square our values and deduct them from 1 any outliers will go to 0. The returned vector we'll call the <code>robust_weights</code>. </p>
<div class="highlight"><pre><span></span><code><span class="n">robust_weights</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cleaned_residuals</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">robust_weights</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_113_output_0.png" /></p>
<p><br></p>
<p>Before we move on we'll combine these into a single step for calculating the <code>robust_weights</code></p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">calc_robust_weights</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">max_std_dev</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates robustifying weightings that penalise outliers&quot;&quot;&quot;</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span>
    <span class="n">std_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">residuals</span><span class="p">),</span> <span class="mf">0.682</span><span class="p">)</span>

    <span class="n">cleaned_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">residuals</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_std_dev</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">robust_weights</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cleaned_residuals</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">robust_weights</span>
</code></pre></div>
<p><br></p>
<p>We'll now refactor our previous <code>lowess_fit_and_predict</code> but this time will enable it to carry out robust regressions</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">robust_lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">robust_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">robust_iters</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fits and predicts robust smoothed local regressions at the specified locations&quot;&quot;&quot;</span>
    <span class="c1"># Identifying the initial loading weights</span>
    <span class="n">weighting_locs</span> <span class="o">=</span> <span class="n">get_weighting_locs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">reg_anchors</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="n">num_fits</span><span class="p">)</span>
    <span class="n">loading_weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">weighting_locs</span><span class="o">=</span><span class="n">weighting_locs</span><span class="p">)</span>

    <span class="c1"># Robustifying the weights (to reduce outlier influence)</span>
    <span class="k">if</span> <span class="n">robust_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">robust_loading_weights</span> <span class="o">=</span> <span class="n">loading_weights</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">robust_loading_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">robust_weights</span><span class="p">,</span> <span class="n">loading_weights</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">robust_loading_weights</span> <span class="o">=</span> <span class="n">robust_loading_weights</span><span class="o">/</span><span class="n">robust_loading_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">robust_loading_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">robust_loading_weights</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">robust_loading_weights</span><span class="p">)</span>

    <span class="c1"># Fitting the model and making predictions</span>
    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">fit_regressions</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">robust_loading_weights</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x_pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_pred</span> <span class="o">=</span> <span class="n">x</span>

    <span class="n">point_evals</span> <span class="o">=</span> <span class="n">design_matrix</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">design_matrix</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">pred_weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">weighting_locs</span><span class="p">)</span>

    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">pred_weights</span><span class="p">,</span> <span class="n">point_evals</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Recursive robust regression</span>
    <span class="n">robust_weights</span> <span class="o">=</span> <span class="n">calc_robust_weights</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">robust_iters</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">robust_iters</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">robust_lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">reg_anchors</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="n">num_fits</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">robust_weights</span><span class="o">=</span><span class="n">robust_weights</span><span class="p">,</span> <span class="n">robust_iters</span><span class="o">=</span><span class="n">robust_iters</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y_pred</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span> <span class="o">=</span> <span class="n">robust_lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Robust LOWESS&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;With Noise&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x2bb8184ca60&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_118_output_1.png" /></p>
<p><br></p>
<p>We've got everything working nicely but the current way we make predictions doesn't make it easy to plug-and-play with other Python libraries, to reduce this friction we'll refactor the code again and create a Scikit-Learn wrapper for our process.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">class</span> <span class="nc">Lowess</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class provides a Scikit-Learn compatible model for Locally Weighted</span>
<span class="sd">    Scatterplot Smoothing, including robustifying procedures against outliers.</span>

<span class="sd">    For more information on the underlying algorithm please refer to</span>
<span class="sd">    * William S. Cleveland: &quot;Robust locally weighted regression and smoothing</span>
<span class="sd">      scatterplots&quot;, Journal of the American Statistical Association, December 1979,</span>
<span class="sd">      volume 74, number 368, pp. 829-836.</span>
<span class="sd">    * William S. Cleveland and Susan J. Devlin: &quot;Locally weighted regression: An</span>
<span class="sd">      approach to regression analysis by local fitting&quot;, Journal of the American</span>
<span class="sd">      Statistical Association, September 1988, volume 83, number 403, pp. 596-610.</span>

<span class="sd">    Example Usage:</span>
<span class="sd">    ```</span>
<span class="sd">    x = np.linspace(0, 5, num=150)</span>
<span class="sd">    y = np.sin(x)</span>
<span class="sd">    y_noisy = y + (np.random.normal(size=len(y)))/10</span>

<span class="sd">    lowess = Lowess()</span>
<span class="sd">    lowess.fit(x, y_noisy, frac=0.2)</span>

<span class="sd">    x_pred = np.linspace(0, 5, 26)</span>
<span class="sd">    y_pred = lowess.predict(x_pred)</span>
<span class="sd">    ```</span>

<span class="sd">    Initialisation Parameters:</span>
<span class="sd">        reg_func: function that accepts the x and y values then returns the intercepts and gradients</span>

<span class="sd">    Attributes:</span>
<span class="sd">        reg_func: function that accepts the x and y values then returns the intercepts and gradients</span>
<span class="sd">        fitted: Boolean flag indicating whether the model has been fitted</span>
<span class="sd">        frac: Fraction of the dataset to use in each local regression</span>
<span class="sd">        weighting_locs: Locations of the local regression centers</span>
<span class="sd">        loading_weights: Weights of each data-point across the localalised models</span>
<span class="sd">        design_matrix: Regression coefficients for each of the localised models</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_func</span><span class="o">=</span><span class="n">calc_lin_reg_betas</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_func</span> <span class="o">=</span> <span class="n">reg_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">calculate_loading_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">external_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">robust_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the loading weights for each data-point across the localised models</span>

<span class="sd">        Parameters:</span>
<span class="sd">            x: values for the independent variable</span>
<span class="sd">            reg_anchors: Locations at which to center the local regressions</span>
<span class="sd">            num_fits: Number of locations at which to carry out a local regression</span>
<span class="sd">            external_weights: Further weighting for the specific regression</span>
<span class="sd">            robust_weights: Robustifying weights to remove the influence of outliers</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Calculating the initial loading weights</span>
        <span class="n">weighting_locs</span> <span class="o">=</span> <span class="n">get_weighting_locs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">reg_anchors</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="n">num_fits</span><span class="p">)</span>
        <span class="n">loading_weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frac</span><span class="p">,</span> <span class="n">weighting_locs</span><span class="o">=</span><span class="n">weighting_locs</span><span class="p">)</span>

        <span class="c1"># Applying weight adjustments</span>
        <span class="k">if</span> <span class="n">external_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">external_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">robust_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">robust_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">weight_adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">external_weights</span><span class="p">,</span> <span class="n">robust_weights</span><span class="p">)</span>
        <span class="n">loading_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">weight_adj</span><span class="p">,</span> <span class="n">loading_weights</span><span class="p">)</span>

        <span class="c1"># Post-processing weights</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">loading_weights</span> <span class="o">=</span> <span class="n">loading_weights</span><span class="o">/</span><span class="n">loading_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># normalising</span>

        <span class="n">loading_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">loading_weights</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">loading_weights</span><span class="p">)</span> <span class="c1"># removing non-finite values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weighting_locs</span> <span class="o">=</span> <span class="n">weighting_locs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loading_weights</span> <span class="o">=</span> <span class="n">loading_weights</span>

        <span class="k">return</span> 


    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">num_fits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">external_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">robust_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">robust_iters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">reg_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculation of the local regression coefficients for </span>
<span class="sd">        a LOWESS model across the dataset provided. This method </span>
<span class="sd">        will reassign the `frac`, `weighting_locs`, `loading_weights`,  </span>
<span class="sd">        and `design_matrix` attributes of the `Lowess` object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            x: values for the independent variable</span>
<span class="sd">            y: values for the dependent variable</span>
<span class="sd">            frac: LOWESS bandwidth for local regression as a fraction</span>
<span class="sd">            reg_anchors: Locations at which to center the local regressions</span>
<span class="sd">            num_fits: Number of locations at which to carry out a local regression</span>
<span class="sd">            external_weights: Further weighting for the specific regression</span>
<span class="sd">            robust_weights: Robustifying weights to remove the influence of outliers</span>
<span class="sd">            robust_iters: Number of robustifying iterations to carry out</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span>

        <span class="c1"># Solving for the design matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_loading_weights</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">reg_anchors</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="n">num_fits</span><span class="p">,</span> <span class="n">external_weights</span><span class="o">=</span><span class="n">external_weights</span><span class="p">,</span> <span class="n">robust_weights</span><span class="o">=</span><span class="n">robust_weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="n">fit_regressions</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loading_weights</span><span class="p">,</span> <span class="n">reg_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_func</span><span class="p">,</span> <span class="o">**</span><span class="n">reg_params</span><span class="p">)</span>

        <span class="c1"># Recursive robust regression</span>
        <span class="k">if</span> <span class="n">robust_iters</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">robust_weights</span> <span class="o">=</span> <span class="n">calc_robust_weights</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

            <span class="n">robust_iters</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frac</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="n">reg_anchors</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="n">num_fits</span><span class="p">,</span> <span class="n">external_weights</span><span class="o">=</span><span class="n">external_weights</span><span class="p">,</span> <span class="n">robust_weights</span><span class="o">=</span><span class="n">robust_weights</span><span class="p">,</span> <span class="n">robust_iters</span><span class="o">=</span><span class="n">robust_iters</span><span class="p">,</span> <span class="o">**</span><span class="n">reg_params</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">y_pred</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> 


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_pred</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inference using the design matrix from the LOWESS fit</span>

<span class="sd">        Parameters:</span>
<span class="sd">            x_pred: Locations for the LOWESS inference</span>

<span class="sd">        Returns:</span>
<span class="sd">            y_pred: Estimated values using the LOWESS fit</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">point_evals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">pred_weights</span> <span class="o">=</span> <span class="n">get_weights_matrix</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frac</span><span class="p">,</span> <span class="n">reg_anchors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weighting_locs</span><span class="p">)</span>

        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">pred_weights</span><span class="p">,</span> <span class="n">point_evals</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">y_pred</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">lowess</span> <span class="o">=</span> <span class="n">Lowess</span><span class="p">()</span>
<span class="n">lowess</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Robust LOWESS&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;With Noise&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x2bb80607e50&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_121_output_1.png" /></p>
<p><br></p>
<h3 id="confidence-intervals">Confidence Intervals<a class="headerlink" href="#confidence-intervals" title="Permanent link">&para;</a></h3>
<ul>
<li>Create the ensemble_results then take the specified confidence range</li>
<li>Put into an sklearn wrapper</li>
</ul>
<p>We're now able to take noisy data and find a robust estimate for the average value at any point, but what about uncertainty? In this work we'll look at two types of uncertainty quantification: confidence &amp; prediction intervals. In this section we will discuss confidence intervals, summarised well in this statement:</p>
<blockquote>
<p>The selection of a confidence level for an interval determines the probability that the confidence interval produced will contain the true parameter value - <a href="http://www.stat.yale.edu/Courses/1997-98/101/confint.htm">stat.yale.edu</a>
We'll start by creating a slightly noiser and longer sin curve than used previously.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">heteroskedasticity_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="mi">10</span>
<span class="n">y_noisy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">heteroskedasticity_factor</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;With Noise&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x2bb806c9e80&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_123_output_1.png" /></p>
<p><br></p>
<p>To determine the confidence in our estimate we want to know how the model will perform against previously unseen data-points. We can randomly separate our data, calculate the error, then repeat many times to obtain a set of possible errors along the curve - this is a specific use-case of the more general bootstrapping approach.</p>
<p>To generate bootstrapped statistics we first need to split our data set, we'll begin by creating a function that returns the indexes for our in- and out-of-bag samples.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">get_bootstrap_idxs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bootstrap_bag_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines the indexes of an array to be used for the in- and out-of-bag bootstrap samples&quot;&quot;&quot;</span>
    <span class="c1"># Bag size handling</span>
    <span class="k">assert</span> <span class="n">bootstrap_bag_size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Bootstrap bag size must be greater than 0&#39;</span>

    <span class="k">if</span> <span class="n">bootstrap_bag_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">bootstrap_bag_size</span><span class="p">)</span> <span class="o">==</span> <span class="n">bootstrap_bag_size</span><span class="p">,</span> <span class="s1">&#39;If the bootstrab bag size is not provided as a fraction then it must be an integer&#39;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">bootstrap_bag_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bootstrap_bag_size</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

    <span class="c1"># Splitting in-bag and out-of-bag samlpes</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

    <span class="n">ib_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="n">bootstrap_bag_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">oob_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="n">ib_idxs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ib_idxs</span><span class="p">,</span> <span class="n">oob_idxs</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ib_idxs</span><span class="p">,</span> <span class="n">oob_idxs</span> <span class="o">=</span> <span class="n">get_bootstrap_idxs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;in-bag: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ib_idxs</span><span class="p">)</span><span class="si">}</span><span class="s1">, out-of-bag: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">oob_idxs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>in-bag: 250, out-of-bag: 305
</code></pre></div>
<p><br></p>
<p>We'll now calculate the standard deviation of the in- and out-of-bag errors</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">get_bootstrap_resid_std_devs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bag_size</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Lowess</span><span class="p">(),</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the standard deviation of the in- and out-of-bag errors&quot;&quot;&quot;</span>
    <span class="c1"># Splitting the in- and out-of-bag samples</span>
    <span class="n">ib_idxs</span><span class="p">,</span> <span class="n">oob_idxs</span> <span class="o">=</span> <span class="n">get_bootstrap_idxs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bag_size</span><span class="p">)</span>

    <span class="n">x_ib</span><span class="p">,</span> <span class="n">x_oob</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ib_idxs</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">oob_idxs</span><span class="p">]</span>
    <span class="n">y_ib</span><span class="p">,</span> <span class="n">y_oob</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ib_idxs</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">oob_idxs</span><span class="p">]</span>

    <span class="c1"># Fitting and predicting with the model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_ib</span><span class="p">,</span> <span class="n">y_ib</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>

    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_ib_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_ib</span><span class="p">)</span>
    <span class="n">y_oob_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_oob</span><span class="p">)</span>

    <span class="c1"># Calculating the error</span>
    <span class="n">y_ib_resids</span> <span class="o">=</span> <span class="n">y_ib</span> <span class="o">-</span> <span class="n">y_ib_pred</span>
    <span class="n">ib_resid_std_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_ib_resids</span><span class="p">))</span>

    <span class="n">y_oob_resids</span> <span class="o">=</span> <span class="n">y_oob</span> <span class="o">-</span> <span class="n">y_oob_pred</span>
    <span class="n">oob_resid_std_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_oob_resids</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ib_resid_std_dev</span><span class="p">,</span> <span class="n">oob_resid_std_dev</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">get_bootstrap_resid_std_devs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bag_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(0.006200435566114433, 0.015852790335401688)
</code></pre></div>
<p><br></p>
<p>We'll quickly plot the distributions of the errors for each set</p>
<div class="highlight"><pre><span></span><code><span class="n">bag_size</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">num_runs</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">ib_resid_std_devs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">oob_resid_std_devs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">model_run</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_runs</span><span class="p">)):</span>
    <span class="n">ib_resid_std_dev</span><span class="p">,</span> <span class="n">oob_resid_std_dev</span> <span class="o">=</span> <span class="n">get_bootstrap_resid_std_devs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">bag_size</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">ib_resid_std_devs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ib_resid_std_dev</span><span class="p">]</span>
    <span class="n">oob_resid_std_devs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">oob_resid_std_dev</span><span class="p">]</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">ib_resid_std_devs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;In-Bag&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">oob_resid_std_devs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Out-of-Bag&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residual</span><span class="se">\&#39;</span><span class="s1">s Standard Deviation&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1000/1000 [00:25&lt;00:00, 39.26it/s]





Text(0.5, 0, &quot;Residual&#39;s Standard Deviation&quot;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_131_output_2.png" /></p>
<p><br></p>
<p>We'll now create two wrapper functions, one for running models, the other for bootstrapping them. The returned <code>df_bootstrap</code> includes the predictions for each model run.</p>
<p>N.b. the <code>bootstrap_model</code> is a generalisable function that will work with any Scikit-Learn compatible model.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">run_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bag_size</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Lowess</span><span class="p">(),</span> <span class="n">x_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fits a model and then uses it to make a prediction&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x_pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_pred</span> <span class="o">=</span> <span class="n">x</span>

    <span class="c1"># Splitting the in- and out-of-bag samples</span>
    <span class="n">ib_idxs</span><span class="p">,</span> <span class="n">oob_idxs</span> <span class="o">=</span> <span class="n">get_bootstrap_idxs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bag_size</span><span class="p">)</span>
    <span class="n">x_ib</span><span class="p">,</span> <span class="n">y_ib</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ib_idxs</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">ib_idxs</span><span class="p">]</span>

    <span class="c1"># Fitting and predicting the model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_ib</span><span class="p">,</span> <span class="n">y_ib</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y_pred</span>

<span class="k">def</span> <span class="nf">bootstrap_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bag_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Lowess</span><span class="p">(),</span> <span class="n">x_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Repeatedly fits and predicts using the specified model, using different subsets of the data each time&quot;&quot;&quot;</span>
    <span class="c1"># Creating the ensemble predictions</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">bootstrap_run</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_runs</span><span class="p">)):</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">run_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bag_size</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">+=</span> <span class="p">[</span><span class="n">y_pred</span><span class="p">]</span>

    <span class="c1"># Wrangling into a dataframe</span>
    <span class="n">df_bootstrap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">df_bootstrap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="n">df_bootstrap</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bootstrap_run&#39;</span>

    <span class="k">return</span> <span class="n">df_bootstrap</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_bootstrap</span> <span class="o">=</span> <span class="n">bootstrap_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">df_bootstrap</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1000/1000 [00:20&lt;00:00, 48.74it/s]
</code></pre></div>
<table>
<thead>
<tr>
<th align="right">x</th>
<th align="right">0</th>
<th align="right">1</th>
<th align="right">2</th>
<th align="right">3</th>
<th align="right">4</th>
<th align="right">5</th>
<th align="right">6</th>
<th align="right">7</th>
<th align="right">8</th>
<th align="right">9</th>
<th align="left">...</th>
<th align="right">990</th>
<th align="right">991</th>
<th align="right">992</th>
<th align="right">993</th>
<th align="right">994</th>
<th align="right">995</th>
<th align="right">996</th>
<th align="right">997</th>
<th align="right">998</th>
<th align="right">999</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">0</td>
<td align="right">0.100492</td>
<td align="right">0.285576</td>
<td align="right">0.168229</td>
<td align="right">0.081885</td>
<td align="right">0.09317</td>
<td align="right">0.126089</td>
<td align="right">0.141063</td>
<td align="right">0.136327</td>
<td align="right">0.106476</td>
<td align="right">0.143553</td>
<td align="left">...</td>
<td align="right">0.192997</td>
<td align="right">0.128739</td>
<td align="right">0.103581</td>
<td align="right">-0.007503</td>
<td align="right">0.150398</td>
<td align="right">0.079978</td>
<td align="right">0.091975</td>
<td align="right">0.070497</td>
<td align="right">0.159256</td>
<td align="right">0.165584</td>
</tr>
<tr>
<td align="right">0.02004</td>
<td align="right">0.113847</td>
<td align="right">0.294801</td>
<td align="right">0.17931</td>
<td align="right">0.095949</td>
<td align="right">0.107318</td>
<td align="right">0.139106</td>
<td align="right">0.153485</td>
<td align="right">0.147965</td>
<td align="right">0.116911</td>
<td align="right">0.155677</td>
<td align="left">...</td>
<td align="right">0.204612</td>
<td align="right">0.142545</td>
<td align="right">0.117383</td>
<td align="right">0.009169</td>
<td align="right">0.162007</td>
<td align="right">0.095014</td>
<td align="right">0.106273</td>
<td align="right">0.0849</td>
<td align="right">0.170189</td>
<td align="right">0.176606</td>
</tr>
<tr>
<td align="right">0.04008</td>
<td align="right">0.12719</td>
<td align="right">0.304004</td>
<td align="right">0.190375</td>
<td align="right">0.110005</td>
<td align="right">0.121457</td>
<td align="right">0.152109</td>
<td align="right">0.165898</td>
<td align="right">0.159591</td>
<td align="right">0.127338</td>
<td align="right">0.167791</td>
<td align="left">...</td>
<td align="right">0.21621</td>
<td align="right">0.156338</td>
<td align="right">0.131174</td>
<td align="right">0.025814</td>
<td align="right">0.173607</td>
<td align="right">0.110028</td>
<td align="right">0.120561</td>
<td align="right">0.099295</td>
<td align="right">0.181101</td>
<td align="right">0.187611</td>
</tr>
<tr>
<td align="right">0.06012</td>
<td align="right">0.140522</td>
<td align="right">0.313186</td>
<td align="right">0.201427</td>
<td align="right">0.124052</td>
<td align="right">0.1356</td>
<td align="right">0.165098</td>
<td align="right">0.178302</td>
<td align="right">0.171205</td>
<td align="right">0.137758</td>
<td align="right">0.179896</td>
<td align="left">...</td>
<td align="right">0.227794</td>
<td align="right">0.170119</td>
<td align="right">0.144954</td>
<td align="right">0.042432</td>
<td align="right">0.185199</td>
<td align="right">0.125022</td>
<td align="right">0.13484</td>
<td align="right">0.113681</td>
<td align="right">0.191995</td>
<td align="right">0.198601</td>
</tr>
<tr>
<td align="right">0.08016</td>
<td align="right">0.153863</td>
<td align="right">0.322348</td>
<td align="right">0.212466</td>
<td align="right">0.138132</td>
<td align="right">0.149829</td>
<td align="right">0.178098</td>
<td align="right">0.190696</td>
<td align="right">0.182827</td>
<td align="right">0.148178</td>
<td align="right">0.192006</td>
<td align="left">...</td>
<td align="right">0.239364</td>
<td align="right">0.183889</td>
<td align="right">0.158744</td>
<td align="right">0.059027</td>
<td align="right">0.196799</td>
<td align="right">0.139998</td>
<td align="right">0.149172</td>
<td align="right">0.128065</td>
<td align="right">0.202871</td>
<td align="right">0.209576</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>Using <code>df_bootstrap</code> we can calculate the confidence interval of our predictions, the Pandas DataFrame <code>quantile</code> method makes this particularly simple.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">get_confidence_interval</span><span class="p">(</span><span class="n">df_bootstrap</span><span class="p">,</span> <span class="n">conf_pct</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Estimates the confidence interval of a prediction based on the bootstrapped estimates&quot;&quot;&quot;</span>
    <span class="n">conf_margin</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">conf_pct</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">df_conf_intvl</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df_bootstrap</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="n">df_conf_intvl</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">conf_margin</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_conf_intvl</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_bootstrap</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">conf_margin</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df_conf_intvl</span> <span class="o">=</span> <span class="n">df_conf_intvl</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df_conf_intvl</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_conf_intvl</span> <span class="o">=</span> <span class="n">get_confidence_interval</span><span class="p">(</span><span class="n">df_bootstrap</span><span class="p">,</span> <span class="n">conf_pct</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_conf_intvl</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_conf_intvl</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">],</span> <span class="n">df_conf_intvl</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% Confidence&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;With Noise&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_137_output_0.png" /></p>
<p><br></p>
<h3 id="quantile-predictions">Quantile Predictions<a class="headerlink" href="#quantile-predictions" title="Permanent link">&para;</a></h3>
<p>Earlier when creating our <code>Lowess</code> class we enabled the function used in calculating the design matrix betas to be specified at initialisation. We can now use this to pass a custom function that will calculate the design matrix for a local quantile regression.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">pred_to_quantile_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the quantile error for a prediction&quot;&quot;&quot;</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span>

    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">weights</span><span class="o">*</span><span class="n">residuals</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q</span><span class="o">*</span><span class="n">residuals</span><span class="p">,</span> <span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">residuals</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">loss</span>

<span class="k">def</span> <span class="nf">calc_quant_reg_loss</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a quantile prediction then calculates its error&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">quantile_pred</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">pred_to_quantile_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quantile_pred</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss</span>

<span class="n">calc_quant_reg_betas</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nelder-mead&#39;</span><span class="p">:</span> <span class="n">minimize</span><span class="p">(</span><span class="n">calc_quant_reg_loss</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span><span class="o">.</span><span class="n">x</span>
</code></pre></div>
<p><br></p>
<p>We'll then create a wrapper that will fit the model for several specified quantiles.</p>
<p>N.b. this function should generalise to any Scikit-Learn compatible model that uses <code>q</code> as the kwarg for the quantile.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">quantile_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Lowess</span><span class="p">(</span><span class="n">calc_quant_reg_betas</span><span class="p">),</span> 
                   <span class="n">x_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Model wrapper that will repeatedly fit and predict for the specified quantiles&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">x_pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">q_to_preds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">qs</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>
        <span class="n">q_to_preds</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)</span>

    <span class="n">df_quantiles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">q_to_preds</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span>

    <span class="n">df_quantiles</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
    <span class="n">df_quantiles</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;quantiles&#39;</span>

    <span class="k">return</span> <span class="n">df_quantiles</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_quantiles</span> <span class="o">=</span> <span class="n">quantile_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">robust_iters</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">df_quantiles</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 9/9 [00:09&lt;00:00,  1.11s/it]

Wall time: 9.96 s
</code></pre></div>
<table>
<thead>
<tr>
<th align="right">x</th>
<th align="right">0.1</th>
<th align="right">0.2</th>
<th align="right">0.3</th>
<th align="right">0.4</th>
<th align="right">0.5</th>
<th align="right">0.6</th>
<th align="right">0.7</th>
<th align="right">0.8</th>
<th align="right">0.9</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">0</td>
<td align="right">0.001332</td>
<td align="right">0.019899</td>
<td align="right">0.040851</td>
<td align="right">0.058275</td>
<td align="right">0.079923</td>
<td align="right">0.107117</td>
<td align="right">0.12615</td>
<td align="right">0.20098</td>
<td align="right">0.198097</td>
</tr>
<tr>
<td align="right">0.02004</td>
<td align="right">0.013525</td>
<td align="right">0.033523</td>
<td align="right">0.055063</td>
<td align="right">0.072684</td>
<td align="right">0.094939</td>
<td align="right">0.122101</td>
<td align="right">0.141805</td>
<td align="right">0.215066</td>
<td align="right">0.214086</td>
</tr>
<tr>
<td align="right">0.04008</td>
<td align="right">0.025715</td>
<td align="right">0.047141</td>
<td align="right">0.069255</td>
<td align="right">0.087094</td>
<td align="right">0.109947</td>
<td align="right">0.137091</td>
<td align="right">0.157439</td>
<td align="right">0.229147</td>
<td align="right">0.230071</td>
</tr>
<tr>
<td align="right">0.06012</td>
<td align="right">0.037911</td>
<td align="right">0.060761</td>
<td align="right">0.083439</td>
<td align="right">0.101519</td>
<td align="right">0.124962</td>
<td align="right">0.152102</td>
<td align="right">0.173062</td>
<td align="right">0.243235</td>
<td align="right">0.246067</td>
</tr>
<tr>
<td align="right">0.08016</td>
<td align="right">0.050118</td>
<td align="right">0.074387</td>
<td align="right">0.097623</td>
<td align="right">0.115969</td>
<td align="right">0.139991</td>
<td align="right">0.167139</td>
<td align="right">0.188679</td>
<td align="right">0.257339</td>
<td align="right">0.26208</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>We can visualise the range of our predictions</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_noisy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;With Noise&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_quantiles</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_quantiles</span><span class="p">[</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">df_quantiles</span><span class="p">[</span><span class="mf">0.9</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;10-90% Prediction Interval&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_144_output_0.png" /></p>
<p><br></p>
<h3 id="external-weights">External Weights<a class="headerlink" href="#external-weights" title="Permanent link">&para;</a></h3>
<p>When we made our <code>Lowess</code> class we included the option to specify <code>external_weights</code>, the reason for this is that it allows us to carry out further model smoothing using variables outside of the regression. This makes particular sense for variables such as time.</p>
<p>Lets first plot two subsets of the data to see why we need to do this in the first place.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_EI_model</span> <span class="o">=</span> <span class="n">df_EI</span><span class="p">[[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">,</span> <span class="s1">&#39;demand&#39;</span><span class="p">,</span> <span class="s1">&#39;solar&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">s_price</span> <span class="o">=</span> <span class="n">df_EI_model</span><span class="p">[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">]</span>
<span class="n">s_dispatchable</span> <span class="o">=</span> <span class="n">df_EI_model</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_EI_model</span><span class="p">[[</span><span class="s1">&#39;solar&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="p">[</span><span class="s1">&#39;2010-09&#39;</span><span class="p">:</span><span class="s1">&#39;2011-03&#39;</span><span class="p">],</span> <span class="n">s_price</span><span class="p">[</span><span class="s1">&#39;2010-09&#39;</span><span class="p">:</span><span class="s1">&#39;2011-03&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="p">[</span><span class="s1">&#39;2020-03&#39;</span><span class="p">:</span><span class="s1">&#39;2020-09&#39;</span><span class="p">],</span> <span class="n">s_price</span><span class="p">[</span><span class="s1">&#39;2020-03&#39;</span><span class="p">:</span><span class="s1">&#39;2020-09&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Wind + Solar] (MW)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (Â£/MWh)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0, 0.5, &#39;Price (Â£/MWh)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_146_output_1.png" /></p>
<p><br></p>
<p>Lets start by adding some boolean filters that we'll then cast as integers to act as weights, for one we'll choose an early winter period from the dataset, for the other we'll take the latest summer</p>
<div class="highlight"><pre><span></span><code><span class="n">model_to_dt_weights</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Winter 10-11&#39;</span><span class="p">:</span> <span class="p">((</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="s1">&#39;2011-03&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="s1">&#39;2010-09&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
    <span class="s1">&#39;Summer 20&#39;</span><span class="p">:</span> <span class="p">((</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="s1">&#39;2020-09&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="s1">&#39;2020-03&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">df_preds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">dt_weights</span> <span class="ow">in</span> <span class="n">model_to_dt_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">lowess</span> <span class="o">=</span> <span class="n">Lowess</span><span class="p">()</span>
    <span class="n">lowess</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">s_price</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">external_weights</span><span class="o">=</span><span class="n">dt_weights</span><span class="p">)</span>

    <span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">53</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)</span>

    <span class="n">df_preds</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<p>We'll plot our estimates alongside the true values</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">dt_weights</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_to_dt_weights</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">color</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="p">[</span><span class="n">dt_weights</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)],</span> <span class="n">s_price</span><span class="p">[</span><span class="n">dt_weights</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>

    <span class="n">min_</span><span class="p">,</span> <span class="n">max_</span> <span class="o">=</span> <span class="n">s_dispatchable</span><span class="p">[</span><span class="n">dt_weights</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)]</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">])</span>
    <span class="n">df_preds</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_preds</span><span class="o">.</span><span class="n">index</span><span class="o">&gt;</span><span class="n">min_</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>
    <span class="n">df_preds</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_preds</span><span class="o">.</span><span class="n">index</span><span class="o">&gt;</span><span class="n">min_</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Wind + Solar] (MW)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (Â£/MWh)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0, 0.5, &#39;Price (Â£/MWh)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_150_output_1.png" /></p>
<p><br></p>
<p>Instead of just using a boolean value to indicate whether an observation belongs to a specific date period, we could instead assign weightings based on the distance from specific dates. This has the benefit that we can reuse existing functions that we wrote earlier.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">calc_timedelta_dists</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">central_date</span><span class="p">,</span> <span class="n">threshold_value</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">threshold_units</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps datetimes to weights using the central date and threshold information provided&quot;&quot;&quot;</span>
    <span class="n">timedeltas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">central_date</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">timedelta_dists</span> <span class="o">=</span> <span class="n">timedeltas</span><span class="o">/</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">threshold_value</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">threshold_units</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">timedelta_dists</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">central_date</span> <span class="o">=</span> <span class="s1">&#39;2017-01-01&#39;</span>

<span class="n">timedelta_dists</span> <span class="o">=</span> <span class="n">calc_timedelta_dists</span><span class="p">(</span><span class="n">df_EI</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">central_date</span><span class="p">)</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">dist_to_weights</span><span class="p">(</span><span class="n">timedelta_dists</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_EI</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[&lt;matplotlib.lines.Line2D at 0x2bb8061df10&gt;]
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_153_output_1.png" /></p>
<p><br></p>
<p>We'll create a wrapper that does this for all of the dates at which we wish to create a localised Lowess model</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">construct_dt_weights</span><span class="p">(</span><span class="n">dt_idx</span><span class="p">,</span> <span class="n">reg_dates</span><span class="p">,</span> <span class="n">threshold_value</span><span class="o">=</span><span class="mi">52</span><span class="p">,</span> <span class="n">threshold_units</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructs a set of distance weightings based on the regression dates provided&quot;&quot;&quot;</span>
    <span class="n">dt_to_weights</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">reg_date</span> <span class="ow">in</span> <span class="n">reg_dates</span><span class="p">:</span>
        <span class="n">dt_to_weights</span><span class="p">[</span><span class="n">reg_date</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">calc_timedelta_dists</span><span class="p">(</span><span class="n">dt_idx</span><span class="p">,</span> <span class="n">reg_date</span><span class="p">,</span> <span class="n">threshold_value</span><span class="o">=</span><span class="n">threshold_value</span><span class="p">,</span> <span class="n">threshold_units</span><span class="o">=</span><span class="n">threshold_units</span><span class="p">))</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">dist_to_weights</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">dt_to_weights</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">reg_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2009-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Ys&#39;</span><span class="p">)</span>
<span class="n">dt_to_weights</span> <span class="o">=</span> <span class="n">construct_dt_weights</span><span class="p">(</span><span class="n">df_EI_model</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">reg_dates</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dt_to_weights</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_EI_model</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 1.77 s





&lt;AxesSubplot:ylabel=&#39;local_datetime&#39;&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_156_output_2.png" /></p>
<p><br></p>
<p>We'll create two wrapper functions for fitting the models and estimating using them as an ensemble. We'll also create a function that sanitises the inputs to the <code>SmoothDates</code> fitting method.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">fit_external_weighted_ensemble</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ensemble_member_to_weights</span><span class="p">,</span> <span class="n">lowess_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fits an ensemble of LOWESS models which have varying relevance for each subset of data over time&quot;&quot;&quot;</span>
    <span class="n">ensemble_member_to_models</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ensemble_member</span><span class="p">,</span> <span class="n">ensemble_weights</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">ensemble_member_to_weights</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">ensemble_member_to_models</span><span class="p">[</span><span class="n">ensemble_member</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lowess</span><span class="p">(</span><span class="o">**</span><span class="n">lowess_kwargs</span><span class="p">)</span>
        <span class="n">ensemble_member_to_models</span><span class="p">[</span><span class="n">ensemble_member</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">external_weights</span><span class="o">=</span><span class="n">ensemble_weights</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ensemble_member_to_models</span>

<span class="k">def</span> <span class="nf">get_ensemble_preds</span><span class="p">(</span><span class="n">ensemble_member_to_model</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">53</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Using the fitted ensemble of LOWESS models to generate the predictions for each of them&quot;&quot;&quot;</span>
    <span class="n">ensemble_member_to_preds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ensemble_member</span> <span class="ow">in</span> <span class="n">ensemble_member_to_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">ensemble_member_to_preds</span><span class="p">[</span><span class="n">ensemble_member</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble_member_to_model</span><span class="p">[</span><span class="n">ensemble_member</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_pred</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ensemble_member_to_preds</span>

<span class="k">def</span> <span class="nf">process_smooth_dates_fit_inputs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">reg_dates</span><span class="p">):</span>  
    <span class="sd">&quot;&quot;&quot;Sanitises the inputs to the SmoothDates fitting method&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;If `x` and `y` have indexes then they must be the same&#39;</span>
        <span class="k">if</span> <span class="n">dt_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt_idx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span>

    <span class="k">assert</span> <span class="n">dt_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;`dt_idx` must either be passed directly or `x` and `y` must include indexes&#39;</span>

    <span class="k">if</span> <span class="n">reg_dates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reg_dates</span> <span class="o">=</span> <span class="n">dt_idx</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">reg_dates</span>
</code></pre></div>
<p><br></p>
<p>We now have everything we need to create our <code>SmoothDates</code> class that will enable us to create estimates of the surface fit of a LOWESS model over time</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">class</span> <span class="nc">SmoothDates</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class provides a time-adaptive extension of the classical </span>
<span class="sd">    Locally Weighted Scatterplot Smoothing regression technique, </span>
<span class="sd">    including robustifying procedures against outliers. This model</span>
<span class="sd">    predicts the surface rather than individual point estimates.</span>

<span class="sd">    Initialisation Parameters:</span>
<span class="sd">        frac: Fraction of the dataset to use in each local regression</span>
<span class="sd">        threshold_value: Number of datetime units to use in each regression</span>
<span class="sd">        threshold_units: Datetime unit which should be compatible with pandas `date_range` function</span>

<span class="sd">    Attributes:</span>
<span class="sd">        fitted: Boolean flag indicating whether the model has been fitted</span>
<span class="sd">        frac: Fraction of the dataset to use in each local regression</span>
<span class="sd">        threshold_value: Number of datetime units to use in each regression</span>
<span class="sd">        threshold_units: Datetime unit which should be compatible with pandas `date_range` function</span>
<span class="sd">        ensemble_member_to_weights: Mapping from the regression dates to their respective weightings for each data-point</span>
<span class="sd">        ensemble_member_to_models: Mapping from the regression dates to their localised models</span>
<span class="sd">        reg_dates: Dates at which the local time-adaptive models will be centered around</span>
<span class="sd">        pred_weights: Weightings to map from the local models to the values to be inferenced </span>
<span class="sd">        pred_values: Raw prediction values as generated by each of the individual local models</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">threshold_value</span><span class="o">=</span><span class="mi">52</span><span class="p">,</span> <span class="n">threshold_units</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_value</span> <span class="o">=</span> <span class="n">threshold_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_units</span> <span class="o">=</span> <span class="n">threshold_units</span>


    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lowess_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculation of the local regression coefficients for each of the</span>
<span class="sd">        LOWESS models across the dataset provided. This is a time-adaptive</span>
<span class="sd">        ensembled version of the `Lowess` model.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            x: Values for the independent variable</span>
<span class="sd">            y: Values for the dependent variable</span>
<span class="sd">            dt_idx: Datetime index, if not provided the index of the x and y series will be used</span>
<span class="sd">            reg_dates: Dates at which the local time-adaptive models will be centered around</span>
<span class="sd">            lowess_kwargs: Additional arguments to be passed at model initialisation</span>
<span class="sd">            reg_anchors: Locations at which to center the local regressions</span>
<span class="sd">            num_fits: Number of locations at which to carry out a local regression</span>
<span class="sd">            external_weights: Further weighting for the specific regression</span>
<span class="sd">            robust_weights: Robustifying weights to remove the influence of outliers</span>
<span class="sd">            robust_iters: Number of robustifying iterations to carry out</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;threshold_value&#39;</span><span class="p">,</span> <span class="s1">&#39;threshold_units&#39;</span><span class="p">,</span> <span class="s1">&#39;frac&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">fit_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">attr_value</span> <span class="o">=</span> <span class="n">fit_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">reg_dates</span> <span class="o">=</span> <span class="n">process_smooth_dates_fit_inputs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">reg_dates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_weights</span> <span class="o">=</span> <span class="n">construct_dt_weights</span><span class="p">(</span><span class="n">dt_idx</span><span class="p">,</span> <span class="n">reg_dates</span><span class="p">,</span> 
                                                               <span class="n">threshold_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_value</span><span class="p">,</span> 
                                                               <span class="n">threshold_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_units</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_models</span> <span class="o">=</span> <span class="n">fit_external_weighted_ensemble</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_weights</span><span class="p">,</span> <span class="n">lowess_kwargs</span><span class="o">=</span><span class="n">lowess_kwargs</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frac</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reg_dates</span> <span class="o">=</span> <span class="n">reg_dates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> 


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">53</span><span class="p">),</span> <span class="n">dt_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inference using the design matrix from the time-adaptive LOWESS fits</span>

<span class="sd">        Parameters:</span>
<span class="sd">            x_pred: Independent variable locations for the time-adaptive LOWESS inference</span>
<span class="sd">            dt_pred: Date locations  for the time-adaptive LOWESS inference</span>
<span class="sd">            return_df: Flag specifying whether to return a dataframe or numpy matrix</span>

<span class="sd">        Returns:</span>
<span class="sd">            df_pred/y_pred: Estimated surface of the time-adaptive the LOWESS fit</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">dt_pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dates</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">x_pred</span> <span class="o">=</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_preds</span> <span class="o">=</span> <span class="n">get_ensemble_preds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_models</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pred_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">construct_dt_weights</span><span class="p">(</span><span class="n">dt_pred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dates</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_weights</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pred_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_preds</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_df</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">df_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dt_pred</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">df_pred</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y_pred</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="c1"># Fitting</span>
<span class="n">reg_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2009-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;13W&#39;</span><span class="p">)</span>

<span class="n">smooth_dates</span> <span class="o">=</span> <span class="n">SmoothDates</span><span class="p">()</span>
<span class="n">smooth_dates</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">s_price</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dt_idx</span><span class="o">=</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                 <span class="n">reg_dates</span><span class="o">=</span><span class="n">reg_dates</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">threshold_value</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 49/49 [05:34&lt;00:00,  6.82s/it]


Wall time: 5min 36s
</code></pre></div>
<table>
<thead>
<tr>
<th align="right">Unnamed: 0</th>
<th align="right">2009-01-04</th>
<th align="right">2009-04-05</th>
<th align="right">2009-07-05</th>
<th align="right">2009-10-04</th>
<th align="right">2010-01-03</th>
<th align="right">2010-04-04</th>
<th align="right">2010-07-04</th>
<th align="right">2010-10-03</th>
<th align="right">2011-01-02</th>
<th align="right">2011-04-03</th>
<th align="left">...</th>
<th align="right">2018-09-23</th>
<th align="right">2018-12-23</th>
<th align="right">2019-03-24</th>
<th align="right">2019-06-23</th>
<th align="right">2019-09-22</th>
<th align="right">2019-12-22</th>
<th align="right">2020-03-22</th>
<th align="right">2020-06-21</th>
<th align="right">2020-09-20</th>
<th align="right">2020-12-20</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">8</td>
<td align="right">-8.94494</td>
<td align="right">-9.51974</td>
<td align="right">-8.28428</td>
<td align="right">-4.07312</td>
<td align="right">2.36397</td>
<td align="right">9.20304</td>
<td align="right">15.5523</td>
<td align="right">19.952</td>
<td align="right">21.5384</td>
<td align="right">21.9928</td>
<td align="left">...</td>
<td align="right">28.3222</td>
<td align="right">26.2734</td>
<td align="right">22.3372</td>
<td align="right">17.3046</td>
<td align="right">12.547</td>
<td align="right">8.98005</td>
<td align="right">6.83905</td>
<td align="right">6.27963</td>
<td align="right">6.65813</td>
<td align="right">7.26188</td>
</tr>
<tr>
<td align="right">9</td>
<td align="right">-6.99248</td>
<td align="right">-7.53971</td>
<td align="right">-6.35583</td>
<td align="right">-2.32092</td>
<td align="right">3.85282</td>
<td align="right">10.4279</td>
<td align="right">16.5652</td>
<td align="right">20.8613</td>
<td align="right">22.4654</td>
<td align="right">22.9732</td>
<td align="left">...</td>
<td align="right">29.946</td>
<td align="right">27.9123</td>
<td align="right">24.0496</td>
<td align="right">19.1683</td>
<td align="right">14.5875</td>
<td align="right">11.1863</td>
<td align="right">9.19079</td>
<td align="right">8.70926</td>
<td align="right">9.10023</td>
<td align="right">9.70888</td>
</tr>
<tr>
<td align="right">10</td>
<td align="right">-5.04027</td>
<td align="right">-5.56007</td>
<td align="right">-4.42799</td>
<td align="right">-0.569485</td>
<td align="right">5.34086</td>
<td align="right">11.652</td>
<td align="right">17.5774</td>
<td align="right">21.77</td>
<td align="right">23.3919</td>
<td align="right">23.9533</td>
<td align="left">...</td>
<td align="right">31.579</td>
<td align="right">29.5601</td>
<td align="right">25.771</td>
<td align="right">21.0399</td>
<td align="right">16.6341</td>
<td align="right">13.3969</td>
<td align="right">11.5457</td>
<td align="right">11.1418</td>
<td align="right">11.5459</td>
<td align="right">12.1605</td>
</tr>
<tr>
<td align="right">11</td>
<td align="right">-3.08905</td>
<td align="right">-3.58251</td>
<td align="right">-2.50355</td>
<td align="right">1.17778</td>
<td align="right">6.82498</td>
<td align="right">12.8728</td>
<td align="right">18.587</td>
<td align="right">22.6767</td>
<td align="right">24.316</td>
<td align="right">24.9304</td>
<td align="left">...</td>
<td align="right">33.2324</td>
<td align="right">31.2281</td>
<td align="right">27.5125</td>
<td align="right">22.9319</td>
<td align="right">18.7011</td>
<td align="right">15.628</td>
<td align="right">13.922</td>
<td align="right">13.5968</td>
<td align="right">14.0149</td>
<td align="right">14.6364</td>
</tr>
<tr>
<td align="right">12</td>
<td align="right">-1.1388</td>
<td align="right">-1.60631</td>
<td align="right">-0.581076</td>
<td align="right">2.92264</td>
<td align="right">8.3066</td>
<td align="right">14.0911</td>
<td align="right">19.5944</td>
<td align="right">23.5817</td>
<td align="right">25.239</td>
<td align="right">25.907</td>
<td align="left">...</td>
<td align="right">34.9068</td>
<td align="right">32.9172</td>
<td align="right">29.2753</td>
<td align="right">24.8442</td>
<td align="right">20.7861</td>
<td align="right">17.8751</td>
<td align="right">16.313</td>
<td align="right">16.0661</td>
<td align="right">16.4993</td>
<td align="right">17.1295</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">521</span><span class="p">)</span>

<span class="n">df_pred</span> <span class="o">=</span> <span class="n">smooth_dates</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span>

<span class="n">df_pred</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th align="right">Unnamed: 0</th>
<th align="right">2009-01-04</th>
<th align="right">2009-04-05</th>
<th align="right">2009-07-05</th>
<th align="right">2009-10-04</th>
<th align="right">2010-01-03</th>
<th align="right">2010-04-04</th>
<th align="right">2010-07-04</th>
<th align="right">2010-10-03</th>
<th align="right">2011-01-02</th>
<th align="right">2011-04-03</th>
<th align="left">...</th>
<th align="right">2018-09-23</th>
<th align="right">2018-12-23</th>
<th align="right">2019-03-24</th>
<th align="right">2019-06-23</th>
<th align="right">2019-09-22</th>
<th align="right">2019-12-22</th>
<th align="right">2020-03-22</th>
<th align="right">2020-06-21</th>
<th align="right">2020-09-20</th>
<th align="right">2020-12-20</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">8</td>
<td align="right">-8.94622</td>
<td align="right">-9.52321</td>
<td align="right">-8.29015</td>
<td align="right">-4.08021</td>
<td align="right">2.35777</td>
<td align="right">9.19846</td>
<td align="right">15.5493</td>
<td align="right">19.9497</td>
<td align="right">21.5345</td>
<td align="right">21.9869</td>
<td align="left">...</td>
<td align="right">28.3311</td>
<td align="right">26.2815</td>
<td align="right">22.345</td>
<td align="right">17.3149</td>
<td align="right">12.5615</td>
<td align="right">8.99827</td>
<td align="right">6.8602</td>
<td align="right">6.30183</td>
<td align="right">6.67918</td>
<td align="right">7.2812</td>
</tr>
<tr>
<td align="right">8.1</td>
<td align="right">-8.75097</td>
<td align="right">-9.32519</td>
<td align="right">-8.09729</td>
<td align="right">-3.90497</td>
<td align="right">2.50667</td>
<td align="right">9.32096</td>
<td align="right">15.6506</td>
<td align="right">20.0406</td>
<td align="right">21.6272</td>
<td align="right">22.0849</td>
<td align="left">...</td>
<td align="right">28.4934</td>
<td align="right">26.4453</td>
<td align="right">22.5162</td>
<td align="right">17.5013</td>
<td align="right">12.7656</td>
<td align="right">9.219</td>
<td align="right">7.09552</td>
<td align="right">6.54496</td>
<td align="right">6.92356</td>
<td align="right">7.52606</td>
</tr>
<tr>
<td align="right">8.2</td>
<td align="right">-8.55572</td>
<td align="right">-9.12717</td>
<td align="right">-7.90442</td>
<td align="right">-3.72972</td>
<td align="right">2.65559</td>
<td align="right">9.44347</td>
<td align="right">15.7519</td>
<td align="right">20.1316</td>
<td align="right">21.7199</td>
<td align="right">22.183</td>
<td align="left">...</td>
<td align="right">28.6558</td>
<td align="right">26.6092</td>
<td align="right">22.6874</td>
<td align="right">17.6877</td>
<td align="right">12.9696</td>
<td align="right">9.43967</td>
<td align="right">7.33076</td>
<td align="right">6.788</td>
<td align="right">7.16784</td>
<td align="right">7.77083</td>
</tr>
<tr>
<td align="right">8.3</td>
<td align="right">-8.36047</td>
<td align="right">-8.92915</td>
<td align="right">-7.71153</td>
<td align="right">-3.55445</td>
<td align="right">2.80452</td>
<td align="right">9.56599</td>
<td align="right">15.8532</td>
<td align="right">20.2225</td>
<td align="right">21.8127</td>
<td align="right">22.2811</td>
<td align="left">...</td>
<td align="right">28.8182</td>
<td align="right">26.7731</td>
<td align="right">22.8587</td>
<td align="right">17.874</td>
<td align="right">13.1737</td>
<td align="right">9.66026</td>
<td align="right">7.56589</td>
<td align="right">7.03092</td>
<td align="right">7.41202</td>
<td align="right">8.0155</td>
</tr>
<tr>
<td align="right">8.4</td>
<td align="right">-8.16521</td>
<td align="right">-8.73111</td>
<td align="right">-7.51863</td>
<td align="right">-3.37915</td>
<td align="right">2.95346</td>
<td align="right">9.68853</td>
<td align="right">15.9545</td>
<td align="right">20.3134</td>
<td align="right">21.9054</td>
<td align="right">22.3792</td>
<td align="left">...</td>
<td align="right">28.9806</td>
<td align="right">26.937</td>
<td align="right">23.0299</td>
<td align="right">18.0604</td>
<td align="right">13.3777</td>
<td align="right">9.88076</td>
<td align="right">7.80091</td>
<td align="right">7.2737</td>
<td align="right">7.65606</td>
<td align="right">8.26006</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>We'll now visualise our surface estimate as a wire-plot, showing how the average price of electricity has changed at different levels of residual demand (after RES) over time</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">cax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">]})</span>

<span class="n">df_pred</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">ColorbarBase</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">df_pred</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (Â£/MWh)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>

<span class="n">cax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">labelpad</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">cax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Solar + Wind] (MW)&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0, 0.5, &#39;Demand - [Solar + Wind] (MW)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/dev-03-lowess_cell_164_output_1.png" /></p>
<p><br></p>
<p>Whilst <code>SmoothDates</code> accepts time-series of dispatchable generation and price as inputs to the <code>fit</code> method, <code>predict</code> doesn't accept a time-series of dispatchable generation or return a time-series of price estimates. Instead, <code>predict</code> returns a dataframe of the smoothed surface - unfortunately this is not what we need if we want to interface our work with the wider Python eco-system for sklearn based models. </p>
<p>We'll create a further wrapper on top of <code>SmoothDates</code> that will accept a time-series of dispatchable generation and return the price estimate when the <code>predict</code> method is used. This will later be used for hyper-parameter tuning in, but could also be interfaced with tools such as TPOT for automated pipeline generation (perhaps the MOE estimate could be ensembled as an input to an ML model?).</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">construct_pred_ts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">df_pred</span><span class="p">,</span> <span class="n">rounding_dec</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uses the time-adaptive LOWESS surface to generate time-series prediction&quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">+=</span> <span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rounding_dec</span><span class="p">),</span> <span class="n">dt_idx</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]]</span>

    <span class="n">s_pred_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s_pred_ts</span>

<span class="k">class</span> <span class="nc">LowessDates</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class provides a time-adaptive extension of the classical </span>
<span class="sd">    Locally Weighted Scatterplot Smoothing regression technique, </span>
<span class="sd">    including robustifying procedures against outliers.</span>

<span class="sd">    Initialisation Parameters:</span>
<span class="sd">        frac: Fraction of the dataset to use in each local regression</span>
<span class="sd">        threshold_value: Number of datetime units to use in each regression</span>
<span class="sd">        threshold_units: Datetime unit which should be compatible with pandas `date_range` function</span>

<span class="sd">    Attributes:</span>
<span class="sd">        fitted: Boolean flag indicating whether the model has been fitted</span>
<span class="sd">        frac: Fraction of the dataset to use in each local regression</span>
<span class="sd">        threshold_value: Number of datetime units to use in each regression</span>
<span class="sd">        threshold_units: Datetime unit which should be compatible with pandas `date_range` function</span>
<span class="sd">        ensemble_member_to_weights: Mapping from the regression dates to their respective weightings for each data-point</span>
<span class="sd">        ensemble_member_to_models: Mapping from the regression dates to their localised models</span>
<span class="sd">        reg_dates: Dates at which the local time-adaptive models will be centered around</span>
<span class="sd">        ensemble_member_to_preds: Mapping from the regression dates to their predictions</span>
<span class="sd">        reg_weights: Mapping from the prediction values to the weighting of each time-adaptive model </span>
<span class="sd">        reg_values: Predictions from each regression</span>
<span class="sd">        df_reg: A DataFrame of the time-adaptive surfce regression</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">threshold_value</span><span class="o">=</span><span class="mi">52</span><span class="p">,</span> <span class="n">threshold_units</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">pred_reg_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_value</span> <span class="o">=</span> <span class="n">threshold_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_units</span> <span class="o">=</span> <span class="n">threshold_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_reg_dates</span> <span class="o">=</span> <span class="n">pred_reg_dates</span>


    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lowess_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculation of the local regression coefficients for each of the</span>
<span class="sd">        LOWESS models across the dataset provided. This is a time-adaptive</span>
<span class="sd">        ensembled version of the `Lowess` model.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            x: Values for the independent variable</span>
<span class="sd">            y: Values for the dependent variable</span>
<span class="sd">            dt_idx: Datetime index, if not provided the index of the x and y series will be used</span>
<span class="sd">            reg_dates: Dates at which the local time-adaptive models will be centered around</span>
<span class="sd">            lowess_kwargs: Additional arguments to be passed at model initialisation</span>
<span class="sd">            reg_anchors: Locations at which to center the local regressions</span>
<span class="sd">            num_fits: Number of locations at which to carry out a local regression</span>
<span class="sd">            external_weights: Further weighting for the specific regression</span>
<span class="sd">            robust_weights: Robustifying weights to remove the influence of outliers</span>
<span class="sd">            robust_iters: Number of robustifying iterations to carry out</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;threshold_value&#39;</span><span class="p">,</span> <span class="s1">&#39;threshold_units&#39;</span><span class="p">,</span> <span class="s1">&#39;frac&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">fit_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">attr_value</span> <span class="o">=</span> <span class="n">fit_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">reg_dates</span> <span class="o">=</span> <span class="n">process_smooth_dates_fit_inputs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">reg_dates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_weights</span> <span class="o">=</span> <span class="n">construct_dt_weights</span><span class="p">(</span><span class="n">dt_idx</span><span class="p">,</span> <span class="n">reg_dates</span><span class="p">,</span> 
                                                               <span class="n">threshold_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_value</span><span class="p">,</span> 
                                                               <span class="n">threshold_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_units</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_models</span> <span class="o">=</span> <span class="n">fit_external_weighted_ensemble</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_weights</span><span class="p">,</span> <span class="n">lowess_kwargs</span><span class="o">=</span><span class="n">lowess_kwargs</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frac</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reg_dates</span> <span class="o">=</span> <span class="n">reg_dates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> 


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">reg_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reg_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rounding_dec</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inference using the design matrix from the time-adaptive LOWESS fits</span>

<span class="sd">        Parameters:</span>
<span class="sd">            x_pred: Locations for the time-adaptive LOWESS inference</span>

<span class="sd">        Returns:</span>
<span class="sd">            y_pred: Estimated values using the time-adaptive LOWESS fit</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">reg_dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_reg_dates</span>

        <span class="k">if</span> <span class="n">reg_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reg_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">rounding_dec</span><span class="p">)),</span> <span class="n">rounding_dec</span><span class="p">)</span>
            <span class="n">x_pred</span> <span class="o">=</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rounding_dec</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg_x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">reg_x</span> <span class="o">=</span> <span class="n">reg_x</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Fitting the smoothed regression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_preds</span> <span class="o">=</span> <span class="n">get_ensemble_preds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_models</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">reg_x</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reg_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">construct_dt_weights</span><span class="p">(</span><span class="n">reg_dates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_dates</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_weights</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_member_to_preds</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="n">y_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_reg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_reg</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">reg_dates</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">reg_x</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Making the prediction</span>
        <span class="n">s_pred_ts</span> <span class="o">=</span> <span class="n">construct_pred_ts</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_reg</span><span class="p">,</span> <span class="n">rounding_dec</span><span class="o">=</span><span class="n">rounding_dec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s_pred_ts</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../dev-02-eda/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Exploratory Data Analysis
              </div>
            </div>
          </a>
        
        
          <a href="../dev-04-price-surface-estimation/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Price Curve Estimation
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.08c56446.min.js"></script>
      <script src="../assets/javascripts/bundle.6ced434e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ['header.autohide', 'navigation.tabs', 'navigation.instant', 'search.suggest'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML-full,Safe&amp;delayStartupUntil=configured"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/config/TeX-AMS-MML_HTMLorMML-full.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/config/Safe.js?V=2.7.9"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/extensions/Safe.js?V=2.7.9"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/jax/output/HTML-CSS/fonts/STIX-Web/fontdata.js?V=2.7.9"></script>
      
    
  </body>
</html>