
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.2">
    
    
      
        <title>Price MOE Calculation - Merit-Order-Effect</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.73f7c429.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.39b8e14a.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#price-merit-order-effect-analysis" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Merit-Order-Effect" class="md-header-nav__button md-logo" aria-label="Merit-Order-Effect">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Merit-Order-Effect
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Price MOE Calculation
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/AyrtonB/Merit-Order-Effect/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    AyrtonB/Merit-Order-Effect
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../ug-01-quantile/" class="md-tabs__link">
        User Guide
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../dev-01-retrieval/" class="md-tabs__link md-tabs__link--active">
        Development
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Merit-Order-Effect" class="md-nav__button md-logo" aria-label="Merit-Order-Effect">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Merit-Order-Effect
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/AyrtonB/Merit-Order-Effect/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    AyrtonB/Merit-Order-Effect
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" >
    
    <label class="md-nav__link" for="nav-2">
      User Guide
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="User Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-01-quantile/" class="md-nav__link">
      Quantile Predictions
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-02-confidence/" class="md-nav__link">
      Confidence Intervals
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-03-power-curve/" class="md-nav__link">
      Power Curve Fitting
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ug-04-gb-mcc/" class="md-nav__link">
      Marginal Cost Curve
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  


  
  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Development
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Development" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Development
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-01-retrieval/" class="md-nav__link">
      Data Retrieval
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-02-eda/" class="md-nav__link">
      Exploratory Data Analysis
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-03-lowess/" class="md-nav__link">
      LOWESS
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-04-price-surface-estimation/" class="md-nav__link">
      Price Curve Estimation
    </a>
  </li>

        
          
          
          


  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Price MOE Calculation
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Price MOE Calculation
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    Imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-inputs" class="md-nav__link">
    User Inputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estimating-the-price-surface" class="md-nav__link">
    Estimating the Price Surface
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualising-the-price-surface" class="md-nav__link">
    Visualising the Price Surface
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluating-the-price-curve-predictions" class="md-nav__link">
    Evaluating the Price Curve Predictions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quantifying-visualising-the-merit-order-effect" class="md-nav__link">
    Quantifying &amp; Visualising the Merit Order Effect
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wind-capture-value-ratio" class="md-nav__link">
    Wind Capture-Value Ratio
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#german-model" class="md-nav__link">
    German Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plots" class="md-nav__link">
    Plots
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-results" class="md-nav__link">
    Saving Results
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-06-carbon-surface-estimation-and-moe/" class="md-nav__link">
      Carbon Curve Estimation & MOE
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-07-prediction-confidence-and-intervals/" class="md-nav__link">
      Prediction & Confidence Intervals
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-08-hyper-parameter-tuning/" class="md-nav__link">
      Hyper-Parameter Tuning
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-09-tables-and-figures/" class="md-nav__link">
      Tables & Figures
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../dev-10-ci-cd/" class="md-nav__link">
      CI-CD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    Imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-inputs" class="md-nav__link">
    User Inputs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estimating-the-price-surface" class="md-nav__link">
    Estimating the Price Surface
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualising-the-price-surface" class="md-nav__link">
    Visualising the Price Surface
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluating-the-price-curve-predictions" class="md-nav__link">
    Evaluating the Price Curve Predictions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quantifying-visualising-the-merit-order-effect" class="md-nav__link">
    Quantifying &amp; Visualising the Merit Order Effect
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wind-capture-value-ratio" class="md-nav__link">
    Wind Capture-Value Ratio
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#german-model" class="md-nav__link">
    German Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plots" class="md-nav__link">
    Plots
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-results" class="md-nav__link">
    Saving Results
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/AyrtonB/Merit-Order-Effect/edit/main/docs/dev-05-price-moe.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="price-merit-order-effect-analysis">Price Merit Order Effect Analysis<a class="headerlink" href="#price-merit-order-effect-analysis" title="Permanent link">&para;</a></h1>
<p><a href="https://notebooks.gesis.org/binder/v2/gh/AyrtonB/Merit-Order-Effect/main?filepath=nbs%2Fdev-05-price-moe.ipynb"><img alt="Binder" src="https://notebooks.gesis.org/binder/badge_logo.svg" /></a></p>
<p>This notebook outlines the analysis required to determine the price merit-order-effect of variable renewable generation in the GB and DE power markets.</p>
<p><br></p>
<h3 id="imports">Imports<a class="headerlink" href="#imports" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>

<span class="kn">from</span> <span class="nn">ipypb</span> <span class="kn">import</span> <span class="n">track</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">JSON</span>

<span class="kn">from</span> <span class="nn">moepy</span> <span class="kn">import</span> <span class="n">lowess</span><span class="p">,</span> <span class="n">eda</span>
<span class="kn">from</span> <span class="nn">moepy.surface</span> <span class="kn">import</span> <span class="n">PicklableFunction</span>
</code></pre></div>
<p><br></p>
<h3 id="user-inputs">User Inputs<a class="headerlink" href="#user-inputs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">GB_model_fp</span> <span class="o">=</span> <span class="s1">&#39;../data/models/DAM_price_GB_p50.pkl&#39;</span>
<span class="n">DE_model_fp</span> <span class="o">=</span> <span class="s1">&#39;../data/models/DAM_price_DE_p50.pkl&#39;</span>
<span class="n">load_existing_GB_model</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">load_existing_DE_model</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>
<p><br></p>
<h3 id="estimating-the-price-surface">Estimating the Price Surface<a class="headerlink" href="#estimating-the-price-surface" title="Permanent link">&para;</a></h3>
<p>We'll start by loading in the data</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">df_EI</span> <span class="o">=</span> <span class="n">eda</span><span class="o">.</span><span class="n">load_EI_df</span><span class="p">(</span><span class="s1">&#39;../data/raw/electric_insights.csv&#39;</span><span class="p">)</span>

<span class="n">df_EI</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 1.76 s
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>day_ahead_price</th>
      <th>SP</th>
      <th>imbalance_price</th>
      <th>valueSum</th>
      <th>temperature</th>
      <th>TCO2_per_h</th>
      <th>gCO2_per_kWh</th>
      <th>nuclear</th>
      <th>biomass</th>
      <th>coal</th>
      <th>...</th>
      <th>demand</th>
      <th>pumped_storage</th>
      <th>wind_onshore</th>
      <th>wind_offshore</th>
      <th>belgian</th>
      <th>dutch</th>
      <th>french</th>
      <th>ireland</th>
      <th>northern_ireland</th>
      <th>irish</th>
    </tr>
    <tr>
      <th>local_datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2009-01-01 00:00:00+00:00</th>
      <td>58.05</td>
      <td>1</td>
      <td>74.74</td>
      <td>74.74</td>
      <td>-0.6</td>
      <td>21278.0</td>
      <td>555.0</td>
      <td>6.973</td>
      <td>0.0</td>
      <td>17.650</td>
      <td>...</td>
      <td>38.329</td>
      <td>-0.404</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.977</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.161</td>
    </tr>
    <tr>
      <th>2009-01-01 00:30:00+00:00</th>
      <td>56.33</td>
      <td>2</td>
      <td>74.89</td>
      <td>74.89</td>
      <td>-0.6</td>
      <td>21442.0</td>
      <td>558.0</td>
      <td>6.968</td>
      <td>0.0</td>
      <td>17.770</td>
      <td>...</td>
      <td>38.461</td>
      <td>-0.527</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.977</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.160</td>
    </tr>
    <tr>
      <th>2009-01-01 01:00:00+00:00</th>
      <td>52.98</td>
      <td>3</td>
      <td>76.41</td>
      <td>76.41</td>
      <td>-0.6</td>
      <td>21614.0</td>
      <td>569.0</td>
      <td>6.970</td>
      <td>0.0</td>
      <td>18.070</td>
      <td>...</td>
      <td>37.986</td>
      <td>-1.018</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.977</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.160</td>
    </tr>
    <tr>
      <th>2009-01-01 01:30:00+00:00</th>
      <td>50.39</td>
      <td>4</td>
      <td>37.73</td>
      <td>37.73</td>
      <td>-0.6</td>
      <td>21320.0</td>
      <td>578.0</td>
      <td>6.969</td>
      <td>0.0</td>
      <td>18.022</td>
      <td>...</td>
      <td>36.864</td>
      <td>-1.269</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.746</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.160</td>
    </tr>
    <tr>
      <th>2009-01-01 02:00:00+00:00</th>
      <td>48.70</td>
      <td>5</td>
      <td>59.00</td>
      <td>59.00</td>
      <td>-0.6</td>
      <td>21160.0</td>
      <td>585.0</td>
      <td>6.960</td>
      <td>0.0</td>
      <td>17.998</td>
      <td>...</td>
      <td>36.180</td>
      <td>-1.566</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.730</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.160</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 24 columns</p>
</div>

<p><br></p>
<p>We'll do a quick plot of the average price</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">df_EI</span><span class="p">[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;4W&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Day-Ahead Price</span><span class="se">\n</span><span class="s1">Monthly Average (£/MWh)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0, 0.5, &#39;Day-Ahead Price\nMonthly Average (£/MWh)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_7_1.png" /></p>
<p><br></p>
<p>We'll also visualise individual half-hour periods for two different date ranges in the dataset</p>
<div class="highlight"><pre><span></span><code><span class="n">df_EI_model</span> <span class="o">=</span> <span class="n">df_EI</span><span class="p">[[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">,</span> <span class="s1">&#39;demand&#39;</span><span class="p">,</span> <span class="s1">&#39;solar&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">s_price</span> <span class="o">=</span> <span class="n">df_EI_model</span><span class="p">[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">]</span>
<span class="n">s_dispatchable</span> <span class="o">=</span> <span class="n">df_EI_model</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_EI_model</span><span class="p">[[</span><span class="s1">&#39;solar&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="p">[</span><span class="s1">&#39;2010-03&#39;</span><span class="p">:</span><span class="s1">&#39;2010-09&#39;</span><span class="p">],</span> <span class="n">s_price</span><span class="p">[</span><span class="s1">&#39;2010-03&#39;</span><span class="p">:</span><span class="s1">&#39;2010-09&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="p">[</span><span class="s1">&#39;2020-03&#39;</span><span class="p">:</span><span class="s1">&#39;2020-09&#39;</span><span class="p">],</span> <span class="n">s_price</span><span class="p">[</span><span class="s1">&#39;2020-03&#39;</span><span class="p">:</span><span class="s1">&#39;2020-09&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Wind + Solar] (GW)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (£/MWh)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0, 0.5, &#39;Price (£/MWh)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_9_1.png" /></p>
<p><br></p>
<p>Next we'll load in (or fit) one of the models trained in the previous notebook</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="k">if</span> <span class="n">load_existing_GB_model</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">smooth_dates</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">GB_model_fp</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">reg_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2009-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;13W&#39;</span><span class="p">)</span>

    <span class="n">smooth_dates</span> <span class="o">=</span> <span class="n">lowess</span><span class="o">.</span><span class="n">SmoothDates</span><span class="p">()</span>
    <span class="n">smooth_dates</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">s_price</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dt_idx</span><span class="o">=</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                     <span class="n">reg_dates</span><span class="o">=</span><span class="n">reg_dates</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">threshold_value</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>

    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">smooth_dates</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_fp</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 2.42 s
</code></pre></div>
<p><br></p>
<p>We're now ready to make our price curve predictions, we'll make one for each day that the model used in training</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">581</span><span class="p">)</span>
<span class="n">dt_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2009-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span>

<span class="n">df_pred</span> <span class="o">=</span> <span class="n">smooth_dates</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">dt_pred</span><span class="o">=</span><span class="n">dt_pred</span><span class="p">)</span>
<span class="n">df_pred</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">df_pred</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 469 ms
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2009-01-01</th>
      <th>2009-01-02</th>
      <th>2009-01-03</th>
      <th>2009-01-04</th>
      <th>2009-01-05</th>
      <th>2009-01-06</th>
      <th>2009-01-07</th>
      <th>2009-01-08</th>
      <th>2009-01-09</th>
      <th>2009-01-10</th>
      <th>...</th>
      <th>2020-12-22</th>
      <th>2020-12-23</th>
      <th>2020-12-24</th>
      <th>2020-12-25</th>
      <th>2020-12-26</th>
      <th>2020-12-27</th>
      <th>2020-12-28</th>
      <th>2020-12-29</th>
      <th>2020-12-30</th>
      <th>2020-12-31</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3.0</th>
      <td>-17.494810</td>
      <td>-17.517832</td>
      <td>-17.540635</td>
      <td>-17.563220</td>
      <td>-17.585587</td>
      <td>-17.607740</td>
      <td>-17.629683</td>
      <td>-17.651422</td>
      <td>-17.672962</td>
      <td>-17.694305</td>
      <td>...</td>
      <td>0.194247</td>
      <td>0.203242</td>
      <td>0.212319</td>
      <td>0.221479</td>
      <td>0.230719</td>
      <td>0.240041</td>
      <td>0.249444</td>
      <td>0.258926</td>
      <td>0.268489</td>
      <td>0.278132</td>
    </tr>
    <tr>
      <th>3.1</th>
      <td>-17.296395</td>
      <td>-17.319349</td>
      <td>-17.342086</td>
      <td>-17.364604</td>
      <td>-17.386906</td>
      <td>-17.408993</td>
      <td>-17.430873</td>
      <td>-17.452548</td>
      <td>-17.474024</td>
      <td>-17.495305</td>
      <td>...</td>
      <td>0.404498</td>
      <td>0.413478</td>
      <td>0.422540</td>
      <td>0.431683</td>
      <td>0.440907</td>
      <td>0.450212</td>
      <td>0.459598</td>
      <td>0.469064</td>
      <td>0.478609</td>
      <td>0.488234</td>
    </tr>
    <tr>
      <th>3.2</th>
      <td>-17.098313</td>
      <td>-17.121198</td>
      <td>-17.143867</td>
      <td>-17.166318</td>
      <td>-17.188552</td>
      <td>-17.210574</td>
      <td>-17.232388</td>
      <td>-17.253998</td>
      <td>-17.275410</td>
      <td>-17.296628</td>
      <td>...</td>
      <td>0.614692</td>
      <td>0.623656</td>
      <td>0.632702</td>
      <td>0.641829</td>
      <td>0.651037</td>
      <td>0.660326</td>
      <td>0.669695</td>
      <td>0.679143</td>
      <td>0.688671</td>
      <td>0.698278</td>
    </tr>
    <tr>
      <th>3.3</th>
      <td>-16.900560</td>
      <td>-16.923375</td>
      <td>-16.945975</td>
      <td>-16.968357</td>
      <td>-16.990523</td>
      <td>-17.012478</td>
      <td>-17.034225</td>
      <td>-17.055769</td>
      <td>-17.077116</td>
      <td>-17.098268</td>
      <td>...</td>
      <td>0.824815</td>
      <td>0.833764</td>
      <td>0.842794</td>
      <td>0.851906</td>
      <td>0.861097</td>
      <td>0.870370</td>
      <td>0.879722</td>
      <td>0.889153</td>
      <td>0.898664</td>
      <td>0.908253</td>
    </tr>
    <tr>
      <th>3.4</th>
      <td>-16.703132</td>
      <td>-16.725876</td>
      <td>-16.748404</td>
      <td>-16.770717</td>
      <td>-16.792814</td>
      <td>-16.814700</td>
      <td>-16.836379</td>
      <td>-16.857856</td>
      <td>-16.879136</td>
      <td>-16.900222</td>
      <td>...</td>
      <td>1.034856</td>
      <td>1.043790</td>
      <td>1.052805</td>
      <td>1.061900</td>
      <td>1.071076</td>
      <td>1.080332</td>
      <td>1.089667</td>
      <td>1.099082</td>
      <td>1.108575</td>
      <td>1.118147</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 4383 columns</p>
</div>

<p><br></p>
<h3 id="visualising-the-price-surface">Visualising the Price Surface<a class="headerlink" href="#visualising-the-price-surface" title="Permanent link">&para;</a></h3>
<p>We now want to actually visualise the results of our model, in particular the price surface it's fitted. We'll start by plotting all of the price curves overlapping each other.</p>
<div class="highlight"><pre><span></span><code><span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">cbar_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>

<span class="n">lp</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">])</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">ColorbarBase</span><span class="p">(</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">cbar_ticks</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="n">dt_pred</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dt_pred</span><span class="p">)</span><span class="o">*</span><span class="n">tick_loc</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt_pred</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b %Y&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tick_loc</span> <span class="ow">in</span> <span class="n">cbar_ticks</span><span class="p">])</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Solar + Wind] (GW)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (£/MWh)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Day-Ahead Market Average Price Curve&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0.5, 1.0, &#39;Day-Ahead Market Average Price Curve&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_15_1.png" /></p>
<p><br></p>
<p>Whilst the previous plot might look quite nice it's rather difficult to interpret, an alternative way to visualise how the price curve evolves over time is using a heatmap</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">construct_dispatchable_lims_df</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="p">,</span> <span class="n">rolling_w</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">daily_quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Identifies the rolling limits to be used in masking&quot;&quot;&quot;</span>
    <span class="n">df_dispatchable_lims</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_dispatchable</span>
                            <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">daily_quantiles</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling_w</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">bfill</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                           <span class="p">)</span>

    <span class="n">df_dispatchable_lims</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_dispatchable_lims</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">df_dispatchable_lims</span>

<span class="k">def</span> <span class="nf">construct_pred_mask_df</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">df_dispatchable_lims</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructs a DataFrame mask for the prediction&quot;&quot;&quot;</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">df_pred</span><span class="p">[</span><span class="n">df_dispatchable_lims</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">df_pred_mask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">*</span><span class="n">df_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">index</span><span class="o">=</span><span class="n">df_pred</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">df_pred_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_pred_mask</span> <span class="o">&gt;</span> <span class="n">df_dispatchable_lims</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_pred_mask</span> <span class="o">&lt;</span> <span class="n">df_dispatchable_lims</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">df_pred_mask</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_pred_mask</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_pred_mask</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_dispatchable_lims</span> <span class="o">=</span> <span class="n">construct_dispatchable_lims_df</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="p">)</span>
<span class="n">df_pred_mask</span> <span class="o">=</span> <span class="n">construct_pred_mask_df</span><span class="p">(</span><span class="n">df_pred</span><span class="p">,</span> <span class="n">df_dispatchable_lims</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_pred_mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;AxesSubplot:&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_18_1.png" /></p>
<p><br></p>
<p>The default output for <code>seaborn</code> heatmaps never looks great when one of the axis is a datetime, we'll write a custom class and wrapper to handle this</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">class</span> <span class="nc">AxTransformer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper class for cleaning axis tick locations and labels&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datetime_vals</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datetime_vals</span> <span class="o">=</span> <span class="n">datetime_vals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">process_tick_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick_vals</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tick_vals</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tick_vals</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">tick_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">tick_vals</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime_vals</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">tick_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tick_vals</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

        <span class="n">tick_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tick_vals</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tick_vals</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">):</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;get_</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">axis&#39;</span><span class="p">)()</span>

        <span class="n">tick_locs</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">get_ticklocs</span><span class="p">()</span>
        <span class="n">tick_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_tick_vals</span><span class="p">([</span><span class="n">label</span><span class="o">.</span><span class="n">_text</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">axis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">()])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">tick_vals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tick_locs</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick_vals</span><span class="p">):</span>        
        <span class="n">tick_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_tick_vals</span><span class="p">(</span><span class="n">tick_vals</span><span class="p">)</span>
        <span class="n">tick_locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tick_vals</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">tick_locs</span>

<span class="k">def</span> <span class="nf">set_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">tick_locs</span><span class="p">,</span> <span class="n">tick_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets ticks at standard numerical locations&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tick_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tick_labels</span> <span class="o">=</span> <span class="n">tick_locs</span>
    <span class="n">ax_transformer</span> <span class="o">=</span> <span class="n">AxTransformer</span><span class="p">()</span>
    <span class="n">ax_transformer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="nb">getattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;set_</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">ticks&#39;</span><span class="p">)(</span><span class="n">ax_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">tick_locs</span><span class="p">))</span>
    <span class="nb">getattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;set_</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">ticklabels&#39;</span><span class="p">)(</span><span class="n">tick_labels</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span>

<span class="k">def</span> <span class="nf">set_date_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">date_range_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets ticks at datetime locations&quot;&quot;&quot;</span>
    <span class="n">dt_rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="o">**</span><span class="n">date_range_kwargs</span><span class="p">)</span>

    <span class="n">ax_transformer</span> <span class="o">=</span> <span class="n">AxTransformer</span><span class="p">(</span><span class="n">datetime_vals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax_transformer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="nb">getattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;set_</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">ticks&#39;</span><span class="p">)(</span><span class="n">ax_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dt_rng</span><span class="p">))</span>
    <span class="nb">getattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;set_</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s1">ticklabels&#39;</span><span class="p">)(</span><span class="n">dt_rng</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">date_format</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">htmp</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">60</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_pred_mask</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">60</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Price (£/MWh)&#39;</span><span class="p">})</span>

<span class="n">set_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">set_date_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;2009-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1YS&#39;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">htmp</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Solar + Wind] (GW)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 1.79 s


C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\sklearn\utils\validation.py:63: FutureWarning: Arrays of bytes/strings is being converted to decimal numbers if dtype=&#39;numeric&#39;. This behavior is deprecated in 0.24 and will be removed in 1.1 (renaming of 0.26). Please convert your data to numeric values explicitly instead.
  return f(*args, **kwargs)





Text(144.58333333333331, 0.5, &#39;Demand - [Solar + Wind] (GW)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_21_3.png" /></p>
<p><br></p>
<p>We also want to visualise specific date ranges, here we'll look towards the end of 2020</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">center_date</span> <span class="o">=</span> <span class="s1">&#39;2020-12-01&#39;</span>

<span class="n">dt_min</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">center_date</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dt_max</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">center_date</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">s_dispatchable</span><span class="p">[</span><span class="n">dt_min</span><span class="p">:</span><span class="n">dt_max</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">s_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="n">dt_min</span><span class="p">:</span><span class="n">dt_max</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">lowess</span><span class="o">.</span><span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;November &amp; December 2020&#39;</span><span class="p">)</span> <span class="c1"># remove in the LaTeX plot and just state in the caption</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Solar + Wind] (GW)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Day-Ahead Price (£/MWh)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 58.1 ms


C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\pandas\core\indexes\base.py:5277: FutureWarning: Indexing a timezone-aware DatetimeIndex with a timezone-naive datetime is deprecated and will raise KeyError in a future version.  Use a timezone-aware object instead.
  start_slice, end_slice = self.slice_locs(start, end, step=step, kind=kind)





Text(0, 0.5, &#39;Day-Ahead Price (£/MWh)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_23_3.png" /></p>
<p><br></p>
<h3 id="evaluating-the-price-curve-predictions">Evaluating the Price Curve Predictions<a class="headerlink" href="#evaluating-the-price-curve-predictions" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">construct_df_pred</span><span class="p">(</span><span class="n">model_fp</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">631</span><span class="p">),</span> <span class="n">dt_pred</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2009-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Constructs the prediction surface for the specified pre-fitted model&quot;&quot;&quot;</span>
    <span class="n">smooth_dates</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">model_fp</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">smooth_dates</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">dt_pred</span><span class="o">=</span><span class="n">dt_pred</span><span class="p">)</span>
    <span class="n">df_pred</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">df_pred</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_pred</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">model_fp</span> <span class="o">=</span> <span class="s1">&#39;../data/models/DAM_price_average.pkl&#39;</span>

<span class="n">df_pred</span> <span class="o">=</span> <span class="n">construct_df_pred</span><span class="p">(</span><span class="n">model_fp</span><span class="p">)</span>

<span class="n">df_pred</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2009-01-01</th>
      <th>2009-01-02</th>
      <th>2009-01-03</th>
      <th>2009-01-04</th>
      <th>2009-01-05</th>
      <th>2009-01-06</th>
      <th>2009-01-07</th>
      <th>2009-01-08</th>
      <th>2009-01-09</th>
      <th>2009-01-10</th>
      <th>...</th>
      <th>2020-12-22</th>
      <th>2020-12-23</th>
      <th>2020-12-24</th>
      <th>2020-12-25</th>
      <th>2020-12-26</th>
      <th>2020-12-27</th>
      <th>2020-12-28</th>
      <th>2020-12-29</th>
      <th>2020-12-30</th>
      <th>2020-12-31</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>-2.0</th>
      <td>-28.412220</td>
      <td>-28.430584</td>
      <td>-28.448767</td>
      <td>-28.466768</td>
      <td>-28.484586</td>
      <td>-28.502217</td>
      <td>-28.519660</td>
      <td>-28.536910</td>
      <td>-28.553964</td>
      <td>-28.570820</td>
      <td>...</td>
      <td>-17.546472</td>
      <td>-17.539855</td>
      <td>-17.533145</td>
      <td>-17.526343</td>
      <td>-17.519449</td>
      <td>-17.512463</td>
      <td>-17.505383</td>
      <td>-17.498210</td>
      <td>-17.490944</td>
      <td>-17.483584</td>
    </tr>
    <tr>
      <th>-1.9</th>
      <td>-28.217121</td>
      <td>-28.235428</td>
      <td>-28.253553</td>
      <td>-28.271497</td>
      <td>-28.289259</td>
      <td>-28.306836</td>
      <td>-28.324223</td>
      <td>-28.341419</td>
      <td>-28.358419</td>
      <td>-28.375222</td>
      <td>...</td>
      <td>-17.297928</td>
      <td>-17.291305</td>
      <td>-17.284592</td>
      <td>-17.277786</td>
      <td>-17.270888</td>
      <td>-17.263898</td>
      <td>-17.256815</td>
      <td>-17.249639</td>
      <td>-17.242370</td>
      <td>-17.235007</td>
    </tr>
    <tr>
      <th>-1.8</th>
      <td>-28.022024</td>
      <td>-28.040273</td>
      <td>-28.058341</td>
      <td>-28.076228</td>
      <td>-28.093934</td>
      <td>-28.111455</td>
      <td>-28.128787</td>
      <td>-28.145928</td>
      <td>-28.162875</td>
      <td>-28.179624</td>
      <td>...</td>
      <td>-17.049353</td>
      <td>-17.042726</td>
      <td>-17.036007</td>
      <td>-17.029198</td>
      <td>-17.022296</td>
      <td>-17.015302</td>
      <td>-17.008216</td>
      <td>-17.001037</td>
      <td>-16.993765</td>
      <td>-16.986400</td>
    </tr>
    <tr>
      <th>-1.7</th>
      <td>-27.826927</td>
      <td>-27.845118</td>
      <td>-27.863129</td>
      <td>-27.880959</td>
      <td>-27.898609</td>
      <td>-27.916074</td>
      <td>-27.933352</td>
      <td>-27.950439</td>
      <td>-27.967332</td>
      <td>-27.984028</td>
      <td>...</td>
      <td>-16.800758</td>
      <td>-16.794127</td>
      <td>-16.787404</td>
      <td>-16.780590</td>
      <td>-16.773684</td>
      <td>-16.766687</td>
      <td>-16.759597</td>
      <td>-16.752415</td>
      <td>-16.745141</td>
      <td>-16.737773</td>
    </tr>
    <tr>
      <th>-1.6</th>
      <td>-27.631830</td>
      <td>-27.649963</td>
      <td>-27.667916</td>
      <td>-27.685690</td>
      <td>-27.703284</td>
      <td>-27.720693</td>
      <td>-27.737916</td>
      <td>-27.754949</td>
      <td>-27.771788</td>
      <td>-27.788431</td>
      <td>...</td>
      <td>-16.552156</td>
      <td>-16.545520</td>
      <td>-16.538792</td>
      <td>-16.531974</td>
      <td>-16.525065</td>
      <td>-16.518063</td>
      <td>-16.510970</td>
      <td>-16.503785</td>
      <td>-16.496508</td>
      <td>-16.489138</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 4383 columns</p>
</div>

<p><br></p>
<p>Now we've created our prediction dataframe we can calculate a time-series for our price prediction</p>
<p>N.b. to speed things up every 100th half-hour has been sampled rather than using the full dataset</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">construct_pred_ts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">df_pred</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uses the time-adaptive LOWESS surface to generate time-series prediction&quot;&quot;&quot;</span>
    <span class="n">s_pred_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">s_pred_ts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dt_idx</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">s_pred_ts</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">s_dispatchable</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_EI_model</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_EI_model</span><span class="p">[[</span><span class="s1">&#39;solar&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)]</span>

<span class="n">s_pred_ts</span> <span class="o">=</span> <span class="n">construct_pred_ts</span><span class="p">(</span><span class="n">s_dispatchable</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">df_pred</span><span class="p">)</span>

<span class="n">s_pred_ts</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\pandas\core\indexes\base.py:5277: FutureWarning: Indexing a timezone-aware DatetimeIndex with a timezone-naive datetime is deprecated and will raise KeyError in a future version.  Use a timezone-aware object instead.
  start_slice, end_slice = self.slice_locs(start, end, step=step, kind=kind)
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="2095" value="2095" class="Progress-main"/></progress>
<span class="Progress-label"><strong>100%</strong></span>
<span class="Iteration-label">1600/2095</span>
<span class="Time-label">[00:02<00:00, 0.00s/it]</span></div>

<div class="highlight"><pre><span></span><code>local_datetime
2009-01-01 00:00:00+00:00    39.026220
2009-01-03 02:00:00+00:00    34.314689
2009-01-05 04:00:00+00:00    32.502689
2009-01-07 06:00:00+00:00    42.705269
2009-01-09 08:00:00+00:00    64.025113
dtype: float64
</code></pre></div>
<p><br></p>
<p>We'll quickly inspect the error distribution</p>
<div class="highlight"><pre><span></span><code><span class="n">s_price</span> <span class="o">=</span> <span class="n">df_EI</span><span class="p">[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">]</span>

<span class="n">s_err</span> <span class="o">=</span> <span class="n">s_pred_ts</span> <span class="o">-</span> <span class="n">s_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_pred_ts</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s_err</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">s_err</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>6.8625170828105615
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_31_1.png" /></p>
<p><br></p>
<p>We'll quickly calculate the r2 score for this model, for context the UK day-ahead price multiple linear regression model from the Staffell/Green group achieved an adjusted r2 of <b>0.451</b></p>
<div class="highlight"><pre><span></span><code><span class="n">r2_score</span><span class="p">(</span><span class="n">s_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_pred_ts</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">s_pred_ts</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.46527623686663677
</code></pre></div>
<p><br></p>
<p>Now we'll calculate some error metrics, including the option to remove extreme error outliers</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">calc_error_metrics</span><span class="p">(</span><span class="n">s_err</span><span class="p">,</span> <span class="n">max_err_quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates several error metrics using the passed error series&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">s_err</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s_err</span> <span class="o">=</span> <span class="n">s_err</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="n">max_err_cutoff</span> <span class="o">=</span> <span class="n">s_err</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">max_err_quantile</span><span class="p">)</span>
    <span class="n">s_err</span> <span class="o">=</span> <span class="n">s_err</span><span class="p">[</span><span class="n">s_err</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">max_err_cutoff</span><span class="p">]</span>

    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;median_abs_err&#39;</span><span class="p">:</span> <span class="n">s_err</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
        <span class="s1">&#39;mean_abs_err&#39;</span><span class="p">:</span> <span class="n">s_err</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;root_mean_square_error&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">s_err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">metrics</span> <span class="o">=</span> <span class="n">calc_error_metrics</span><span class="p">(</span><span class="n">s_err</span><span class="p">)</span>

<span class="n">metrics</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>{&#39;median_abs_err&#39;: 4.843738852384298,
 &#39;mean_abs_err&#39;: 6.8625170828105615,
 &#39;root_mean_square_error&#39;: 12.301327313943641}
</code></pre></div>
<p><br></p>
<p>We'll now create a wrapper for the last few steps and repeat the analysis for four variants of the model</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">get_model_pred_ts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">model_fp</span><span class="p">,</span> <span class="n">s_demand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">631</span><span class="p">),</span> <span class="n">dt_pred</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2009-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Constructs the time-series prediction for the specified pre-fitted model&quot;&quot;&quot;</span>
    <span class="n">df_pred</span> <span class="o">=</span> <span class="n">construct_df_pred</span><span class="p">(</span><span class="n">model_fp</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">dt_pred</span><span class="o">=</span><span class="n">dt_pred</span><span class="p">)</span>
    <span class="n">s_cleaned</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">min</span><span class="p">():</span><span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)]</span>
    <span class="n">s_pred_ts</span> <span class="o">=</span> <span class="n">construct_pred_ts</span><span class="p">(</span><span class="n">s_cleaned</span><span class="p">,</span> <span class="n">df_pred</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">s_demand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s_pred_ts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s_cleaned</span> <span class="o">=</span> <span class="n">s_demand</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">min</span><span class="p">():</span><span class="n">df_pred</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)]</span>
        <span class="n">s_pred_ts_demand</span> <span class="o">=</span> <span class="n">construct_pred_ts</span><span class="p">(</span><span class="n">s_cleaned</span><span class="p">,</span> <span class="n">df_pred</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s_pred_ts</span><span class="p">,</span> <span class="n">s_pred_ts_demand</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">s_demand</span> <span class="o">=</span> <span class="n">df_EI</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span>
<span class="n">s_price</span> <span class="o">=</span> <span class="n">df_EI</span><span class="p">[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">]</span>
<span class="n">s_dispatchable</span> <span class="o">=</span> <span class="n">df_EI_model</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_EI_model</span><span class="p">[[</span><span class="s1">&#39;solar&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">model_runs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;demand_p50&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;model_fp&#39;</span><span class="p">:</span> <span class="s1">&#39;../data/models/DAM_price_demand_p50.pkl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">s_demand</span>
    <span class="p">},</span>
    <span class="s1">&#39;demand_avg&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;model_fp&#39;</span><span class="p">:</span> <span class="s1">&#39;../data/models/DAM_price_demand_average.pkl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">s_demand</span>
    <span class="p">},</span>
    <span class="s1">&#39;dispatch_p50&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;model_fp&#39;</span><span class="p">:</span> <span class="s1">&#39;../data/models/DAM_price_p50.pkl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">s_dispatchable</span>
    <span class="p">},</span>
    <span class="s1">&#39;dispatch_avg&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;model_fp&#39;</span><span class="p">:</span> <span class="s1">&#39;../data/models/DAM_price_average.pkl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">s_dispatchable</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">model_outputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_kwargs</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">model_runs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">s_pred_ts</span> <span class="o">=</span> <span class="n">get_model_pred_ts</span><span class="p">(</span><span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>
    <span class="n">s_err</span> <span class="o">=</span> <span class="n">s_pred_ts</span> <span class="o">-</span> <span class="n">s_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_pred_ts</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">calc_error_metrics</span><span class="p">(</span><span class="n">s_err</span><span class="p">)</span>

    <span class="n">model_outputs</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;s_pred_ts&#39;</span><span class="p">:</span> <span class="n">s_pred_ts</span><span class="p">,</span>
        <span class="s1">&#39;s_err&#39;</span><span class="p">:</span> <span class="n">s_err</span><span class="p">,</span>
        <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="n">metrics</span>
    <span class="p">}</span>
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="4" value="4" class="Progress-main"/></progress>
<span class="Progress-label"><strong>100%</strong></span>
<span class="Iteration-label">4/4</span>
<span class="Time-label">[11:27<02:57, 171.67s/it]</span></div>

<div class="highlight"><pre><span></span><code>C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\pandas\core\indexes\base.py:5277: FutureWarning: Indexing a timezone-aware DatetimeIndex with a timezone-naive datetime is deprecated and will raise KeyError in a future version.  Use a timezone-aware object instead.
  start_slice, end_slice = self.slice_locs(start, end, step=step, kind=kind)
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="209736" value="209736" class="Progress-main"/></progress>
<span class="Progress-label"><strong>100%</strong></span>
<span class="Iteration-label">192924/209736</span>
<span class="Time-label">[02:23<00:00, 0.00s/it]</span></div>

<div class="highlight"><pre><span></span><code>C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\pandas\core\indexes\base.py:5277: FutureWarning: Indexing a timezone-aware DatetimeIndex with a timezone-naive datetime is deprecated and will raise KeyError in a future version.  Use a timezone-aware object instead.
  start_slice, end_slice = self.slice_locs(start, end, step=step, kind=kind)
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="209736" value="209736" class="Progress-main"/></progress>
<span class="Progress-label"><strong>100%</strong></span>
<span class="Iteration-label">0/209736</span>
<span class="Time-label">[02:26<00:00, 0.00s/it]</span></div>

<div class="highlight"><pre><span></span><code>C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\pandas\core\indexes\base.py:5277: FutureWarning: Indexing a timezone-aware DatetimeIndex with a timezone-naive datetime is deprecated and will raise KeyError in a future version.  Use a timezone-aware object instead.
  start_slice, end_slice = self.slice_locs(start, end, step=step, kind=kind)
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="209533" value="209533" class="Progress-main"/></progress>
<span class="Progress-label"><strong>100%</strong></span>
<span class="Iteration-label">165505/209533</span>
<span class="Time-label">[03:30<00:00, 0.00s/it]</span></div>

<div class="highlight"><pre><span></span><code>C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\pandas\core\indexes\base.py:5277: FutureWarning: Indexing a timezone-aware DatetimeIndex with a timezone-naive datetime is deprecated and will raise KeyError in a future version.  Use a timezone-aware object instead.
  start_slice, end_slice = self.slice_locs(start, end, step=step, kind=kind)
</code></pre></div>
<div><span class="Text-label" style="display:inline-block; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0; max-width:15ex; vertical-align:middle; text-align:right"></span>
<progress style="width:60ex" max="209533" value="209533" class="Progress-main"/></progress>
<span class="Progress-label"><strong>100%</strong></span>
<span class="Iteration-label">0/209533</span>
<span class="Time-label">[02:53<00:00, 0.00s/it]</span></div>

<p><br></p>
<p>Overall, the dispatch model fitted to the median price appears to be the most accurate</p>
<div class="highlight"><pre><span></span><code><span class="n">df_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span> 
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">outputs</span> 
    <span class="ow">in</span> <span class="n">model_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">})</span>

<span class="n">df_metrics</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>demand_p50</th>
      <th>demand_avg</th>
      <th>dispatch_p50</th>
      <th>dispatch_avg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>median_abs_err</th>
      <td>4.705342</td>
      <td>5.049710</td>
      <td>4.473115</td>
      <td>4.777677</td>
    </tr>
    <tr>
      <th>mean_abs_err</th>
      <td>6.974887</td>
      <td>7.090144</td>
      <td>6.556877</td>
      <td>6.651800</td>
    </tr>
    <tr>
      <th>root_mean_square_error</th>
      <td>12.632306</td>
      <td>12.409950</td>
      <td>12.053854</td>
      <td>11.807459</td>
    </tr>
  </tbody>
</table>
</div>

<p><br></p>
<p>We'll quantify the difference against the standard LOWESS approach</p>
<div class="highlight"><pre><span></span><code><span class="n">old_err</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean_abs_err&#39;</span><span class="p">,</span> <span class="s1">&#39;dispatch_avg&#39;</span><span class="p">]</span>
<span class="n">new_err</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean_abs_err&#39;</span><span class="p">,</span> <span class="s1">&#39;dispatch_p50&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="o">-</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">new_err</span> <span class="o">-</span> <span class="n">old_err</span><span class="p">)</span><span class="o">/</span><span class="n">old_err</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% mean absolute error reduction using the p50 model rather than the average model&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>1.43% mean absolute error reduction using the p50 model rather than the average model
</code></pre></div>
<p><br></p>
<p>And also look at the improvement in accuracy when regressing against dispatchable generation instead of total generation</p>
<div class="highlight"><pre><span></span><code><span class="n">old_err</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean_abs_err&#39;</span><span class="p">,</span> <span class="s1">&#39;demand_avg&#39;</span><span class="p">]</span>
<span class="n">new_err</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mean_abs_err&#39;</span><span class="p">,</span> <span class="s1">&#39;dispatch_avg&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="o">-</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">new_err</span> <span class="o">-</span> <span class="n">old_err</span><span class="p">)</span><span class="o">/</span><span class="n">old_err</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% mean absolute error reduction using the dispatchable demand model rather than just demand&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>6.18% mean absolute error reduction using the dispatchable demand model rather than just demand
</code></pre></div>
<p><br></p>
<h3 id="quantifying-visualising-the-merit-order-effect">Quantifying &amp; Visualising the Merit Order Effect<a class="headerlink" href="#quantifying-visualising-the-merit-order-effect" title="Permanent link">&para;</a></h3>
<p>To begin we'll load up our dispatchable supply model and make an inference for each half-hour in the dataset, based on the results in the previous section we'll use the p50 model.</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">s_GB_demand</span> <span class="o">=</span> <span class="n">df_EI_model</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span>
<span class="n">s_GB_price</span> <span class="o">=</span> <span class="n">df_EI_model</span><span class="p">[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">]</span>
<span class="n">s_GB_dispatchable</span> <span class="o">=</span> <span class="n">df_EI_model</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_EI_model</span><span class="p">[[</span><span class="s1">&#39;solar&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">s_GB_pred_ts_dispatch</span><span class="p">,</span> <span class="n">s_GB_pred_ts_demand</span> <span class="o">=</span> <span class="n">get_model_pred_ts</span><span class="p">(</span><span class="n">s_GB_dispatchable</span><span class="p">,</span> <span class="n">GB_model_fp</span><span class="p">,</span> <span class="n">s_demand</span><span class="o">=</span><span class="n">s_GB_demand</span><span class="p">)</span>

<span class="n">s_dispatch_GB_err</span> <span class="o">=</span> <span class="n">s_GB_pred_ts_dispatch</span> <span class="o">-</span> <span class="n">s_GB_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_GB_pred_ts_dispatch</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">GB_dispatch_metrics</span> <span class="o">=</span> <span class="n">calc_error_metrics</span><span class="p">(</span><span class="n">s_dispatch_GB_err</span><span class="p">)</span>

<span class="n">s_demand_GB_err</span> <span class="o">=</span> <span class="n">s_GB_pred_ts_demand</span> <span class="o">-</span> <span class="n">s_GB_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_GB_pred_ts_demand</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">GB_demand_metrics</span> <span class="o">=</span> <span class="n">calc_error_metrics</span><span class="p">(</span><span class="n">s_demand_GB_err</span><span class="p">)</span>

<span class="n">s_GB_pred_ts_dispatch</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 92.1 ms





local_datetime
2009-01-01 00:00:00+00:00    37.203441
2009-01-01 00:30:00+00:00    37.313379
2009-01-01 01:00:00+00:00    36.768513
2009-01-01 01:30:00+00:00    35.595162
2009-01-01 02:00:00+00:00    34.849422
                               ...    
2020-12-30 21:30:00+00:00    48.066638
2020-12-30 22:00:00+00:00    45.268069
2020-12-30 22:30:00+00:00    42.647597
2020-12-30 23:00:00+00:00    39.520118
2020-12-30 23:30:00+00:00    37.948852
Length: 209533, dtype: float64
</code></pre></div>
<p><br></p>
<p>The difference between the price forecast when using the dispatchable generation and total generation is due to the merit order effect</p>
<div class="highlight"><pre><span></span><code><span class="n">s_GB_MOE</span> <span class="o">=</span> <span class="n">s_GB_pred_ts_demand</span> <span class="o">-</span> <span class="n">s_GB_pred_ts_dispatch</span>
<span class="n">s_GB_MOE</span> <span class="o">=</span> <span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;AxesSubplot:xlabel=&#39;local_datetime&#39;&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_49_1.png" /></p>
<p><br></p>
<p>We'll quickly calculate the averages for 2010 and 2020</p>
<div class="highlight"><pre><span></span><code><span class="n">s_GB_MOE</span><span class="p">[</span><span class="s1">&#39;2010&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">s_GB_MOE</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(0.8813580281178922, 13.888630517942211)
</code></pre></div>
<p><br></p>
<p>We'll also visualise the predictions for a sample day</p>
<div class="highlight"><pre><span></span><code><span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;2017-07-01&#39;</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">s_GB_pred_ts_dispatch</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction with RES&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">s_GB_pred_ts_demand</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction without RES&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">s_GB_price</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.075</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (£/MWh)&#39;</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_53_0.png" /></p>
<p><br></p>
<p>We can see that there is a clear pattern in the bias over the course of the day</p>
<div class="highlight"><pre><span></span><code><span class="n">s_GB_err</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s_GB_err</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="o">+</span><span class="n">s_GB_err</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">minute</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;AxesSubplot:xlabel=&#39;local_datetime&#39;&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_55_1.png" /></p>
<p><br></p>
<p>We'll now calculate the half-hourly savings due to the merit order effect. The demand is expressed in terms of GW which we'll convert into MWh to be compatible with the units of the merit order effect.</p>
<div class="highlight"><pre><span></span><code><span class="n">s_GB_saving</span> <span class="o">=</span> <span class="n">s_GB_MOE</span> <span class="o">*</span> <span class="n">s_GB_demand</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mf">0.5</span>

<span class="n">s_GB_saving</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;2W&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;AxesSubplot:xlabel=&#39;local_datetime&#39;&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_57_1.png" /></p>
<p><br></p>
<p>The distribution of the price savings appears to follow a rough Pareto distribution</p>
<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">s_GB_saving</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">750000</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_59_0.png" /></p>
<p><br></p>
<p>We'll calculate the total savings over the dataset period</p>
<div class="highlight"><pre><span></span><code><span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2010&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2020&#39;</span>

<span class="n">total_saving</span> <span class="o">=</span> <span class="n">s_GB_saving</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_date</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The total saving between </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2"> was £</span><span class="si">{</span><span class="n">total_saving</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>The total saving between 2010 and 2020 was £17,454,468,143
</code></pre></div>
<p><br></p>
<p>To add some context we'll calculate the average half-hourly market volume (note that the DAM volume will be smaller than demand but it acts as a good proxy to cover all markets)</p>
<div class="highlight"><pre><span></span><code><span class="n">s_mkt_cost</span> <span class="o">=</span> <span class="n">df_EI</span><span class="p">[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df_EI</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mf">0.5</span>
<span class="n">avg_HH_mkt_cost</span> <span class="o">=</span> <span class="n">s_mkt_cost</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">avg_HH_mkt_cost</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>784440.8559554707
</code></pre></div>
<p><br></p>
<p>We'll also calculate the long-term price reduction due to the merit order effect</p>
<div class="highlight"><pre><span></span><code><span class="n">s_GB_MOE</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_date</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">df_EI</span><span class="p">[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">s_GB_MOE</span><span class="p">)[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_date</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.15034496268274428
</code></pre></div>
<p><br></p>
<p>This only tells part of the story though, lets look at how this value evolves over time</p>
<div class="highlight"><pre><span></span><code><span class="n">s_GB_DAM</span> <span class="o">=</span> <span class="n">s_GB_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

<span class="n">s_GB_MOE_rolling</span> <span class="o">=</span> <span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">48</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">s_GB_DAM_rolling</span> <span class="o">=</span> <span class="n">s_GB_DAM</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">48</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">s_GB_MOE_pct_reduction</span> <span class="o">=</span> <span class="n">s_GB_MOE_rolling</span><span class="o">/</span><span class="n">s_GB_DAM_rolling</span>

<span class="n">s_GB_MOE_pct_reduction</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;AxesSubplot:xlabel=&#39;local_datetime&#39;&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_67_1.png" /></p>
<p><br></p>
<p>We're half-way to creating the metrics required for comparing between markets of different sizes, prices and RES penetration. We'll calculate the renewables penetration percentage and then aggregate it on an annual basis alongside the pct price reduction due to the MOE.</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">s_GB_MOE_pct_annual_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_GB_MOE</span><span class="o">/</span><span class="p">(</span><span class="n">df_EI</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">s_GB_MOE</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">s_GB_RES_pct_annual_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_EI</span><span class="p">[[</span><span class="s1">&#39;wind&#39;</span><span class="p">,</span> <span class="s1">&#39;solar&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">df_EI</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">s_GB_RES_pct_annual_avg</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">s_GB_MOE_pct_annual_avg</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Incl. 2020 (m=0.86)&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">s_GB_RES_pct_annual_avg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="mi">2019</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">s_GB_MOE_pct_annual_avg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="mi">2019</span><span class="p">],</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Excl. 2020 (m=0.67)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">s_GB_RES_pct_annual_avg</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">s_GB_MOE_pct_annual_avg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Average RES Penetration (%)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average MOE Price Reduction (%)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 753 ms





Text(0, 0.5, &#39;Average MOE Price Reduction (%)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_69_2.png" /></p>
<p><br></p>
<p>We'll fit a linear regression that includes 2020</p>
<div class="highlight"><pre><span></span><code><span class="n">linreg_results</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_GB_RES_pct_annual_avg</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">s_GB_MOE_pct_annual_avg</span><span class="p">)</span>

<span class="n">linreg_results</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>LinregressResult(slope=0.8635390661954275, intercept=-0.01260770809733558, rvalue=0.9407770535093302, pvalue=5.192107447861512e-06, stderr=0.0984074783808127, intercept_stderr=0.01545140550162944)
</code></pre></div>
<p><br></p>
<p>And one that excludes 2020</p>
<div class="highlight"><pre><span></span><code><span class="n">max_year</span> <span class="o">=</span> <span class="mi">2019</span>
<span class="n">linreg_results</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_GB_RES_pct_annual_avg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">max_year</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">s_GB_MOE_pct_annual_avg</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">max_year</span><span class="p">])</span>

<span class="n">linreg_results</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>LinregressResult(slope=0.6675133238057994, intercept=0.004850800918389769, rvalue=0.9588281998847612, pvalue=3.215977627236812e-06, stderr=0.06590160431497857, intercept_stderr=0.009037033037260158)
</code></pre></div>
<p><br></p>
<p>We'll also visualise the how the MOE time-series and trend</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">s_GB_MOE</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">s_GB_MOE_rolling</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;28-Day Average&#39;</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2010&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2021&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Merit Order Effect (£/MWh)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x22ccd2776d0&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_75_1.png" /></p>
<p><br></p>
<p>We can also attribute specific savings from the MOE to the different RES technologies</p>
<div class="highlight"><pre><span></span><code><span class="n">wind_weight</span> <span class="o">=</span> <span class="n">df_EI</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df_EI</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">][[</span><span class="s1">&#39;wind&#39;</span><span class="p">,</span> <span class="s1">&#39;solar&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">solar_weight</span> <span class="o">=</span> <span class="n">df_EI</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;solar&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df_EI</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">][[</span><span class="s1">&#39;wind&#39;</span><span class="p">,</span> <span class="s1">&#39;solar&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">s_wind_MOE</span> <span class="o">=</span> <span class="n">s_GB_MOE</span><span class="o">*</span><span class="n">wind_weight</span>
<span class="n">s_solar_MOE</span> <span class="o">=</span> <span class="n">s_GB_MOE</span><span class="o">*</span><span class="n">solar_weight</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">s_wind_MOE</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">48</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Wind&#39;</span><span class="p">)</span>
<span class="n">s_solar_MOE</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">48</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Solar&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2010&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2021&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Merit Order Effect (£/MWh)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_77_0.png" /></p>
<p><br></p>
<p>To add some context we'll plot the MOE alongside the actual price, we'll also do this for both years at the extremes of the dataset time range</p>
<div class="highlight"><pre><span></span><code><span class="n">year_1</span> <span class="o">=</span> <span class="s1">&#39;2010&#39;</span>
<span class="n">year_2</span> <span class="o">=</span> <span class="s1">&#39;2020&#39;</span>

<span class="n">month_num_to_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)))</span>

<span class="n">s_hourly_dam_10</span> <span class="o">=</span> <span class="n">s_GB_DAM</span><span class="p">[</span><span class="n">year_1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s_GB_DAM</span><span class="p">[</span><span class="n">year_1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">s_hourly_MOE_10</span> <span class="o">=</span> <span class="n">s_GB_MOE</span><span class="p">[</span><span class="n">year_1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s_GB_MOE</span><span class="p">[</span><span class="n">year_1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">s_hourly_dam_20</span> <span class="o">=</span> <span class="n">s_GB_DAM</span><span class="p">[</span><span class="n">year_2</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s_GB_DAM</span><span class="p">[</span><span class="n">year_2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">s_hourly_MOE_20</span> <span class="o">=</span> <span class="n">s_GB_MOE</span><span class="p">[</span><span class="n">year_2</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s_GB_MOE</span><span class="p">[</span><span class="n">year_2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s_hourly_dam_10</span><span class="p">,</span> <span class="n">s_hourly_MOE_10</span><span class="p">,</span> <span class="n">s_hourly_dam_20</span><span class="p">,</span> <span class="n">s_hourly_MOE_20</span><span class="p">]:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">month_num_to_name</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="p">(</span><span class="n">s_hourly_dam_10</span><span class="o">+</span><span class="n">s_hourly_MOE_10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MOE&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">s_hourly_dam_10</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="p">(</span><span class="n">s_hourly_dam_20</span><span class="o">+</span><span class="n">s_hourly_MOE_20</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MOE&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">s_hourly_dam_20</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Day-Ahead&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">year_1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">year_2</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">positions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (£/MWh)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0, 0.5, &#39;Price (£/MWh)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_79_1.png" /></p>
<p><br></p>
<p>We'll create a combined dataframe of the predicted and observed time-series </p>
<div class="highlight"><pre><span></span><code><span class="n">df_GB_results_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">s_GB_pred_ts_dispatch</span><span class="p">,</span>
    <span class="s1">&#39;counterfactual&#39;</span><span class="p">:</span> <span class="n">s_GB_pred_ts_demand</span><span class="p">,</span>
    <span class="s1">&#39;observed&#39;</span><span class="p">:</span> <span class="n">s_GB_price</span><span class="p">,</span>
    <span class="s1">&#39;moe&#39;</span><span class="p">:</span> <span class="n">s_GB_MOE</span>
<span class="p">})</span>

<span class="n">df_GB_results_ts</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prediction</th>
      <th>counterfactual</th>
      <th>observed</th>
      <th>moe</th>
    </tr>
    <tr>
      <th>local_datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2009-01-01 00:00:00+00:00</th>
      <td>37.203441</td>
      <td>37.313379</td>
      <td>58.05</td>
      <td>0.109938</td>
    </tr>
    <tr>
      <th>2009-01-01 00:30:00+00:00</th>
      <td>37.313379</td>
      <td>37.535135</td>
      <td>56.33</td>
      <td>0.221756</td>
    </tr>
    <tr>
      <th>2009-01-01 01:00:00+00:00</th>
      <td>36.768513</td>
      <td>36.985087</td>
      <td>52.98</td>
      <td>0.216574</td>
    </tr>
    <tr>
      <th>2009-01-01 01:30:00+00:00</th>
      <td>35.595162</td>
      <td>35.807631</td>
      <td>50.39</td>
      <td>0.212469</td>
    </tr>
    <tr>
      <th>2009-01-01 02:00:00+00:00</th>
      <td>34.849422</td>
      <td>35.063119</td>
      <td>48.70</td>
      <td>0.213697</td>
    </tr>
  </tbody>
</table>
</div>

<p><br></p>
<p>Which we'll then save as a csv</p>
<div class="highlight"><pre><span></span><code><span class="n">df_GB_results_ts</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/results/GB_price.csv&#39;</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<h3 id="wind-capture-value-ratio">Wind Capture-Value Ratio<a class="headerlink" href="#wind-capture-value-ratio" title="Permanent link">&para;</a></h3>
<p>Now we'll turn our focus to calculating the capture-value ratio of wind over time</p>
<div class="highlight"><pre><span></span><code><span class="n">s_wind</span> <span class="o">=</span> <span class="n">df_EI</span><span class="p">[[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()[</span><span class="s1">&#39;wind&#39;</span><span class="p">]</span>
<span class="n">s_dam</span> <span class="o">=</span> <span class="n">df_EI</span><span class="p">[[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()[</span><span class="s1">&#39;day_ahead_price&#39;</span><span class="p">]</span>
</code></pre></div>
<p><br></p>
<p>We'll do this by weighting the price time-series using the wind generation data</p>
<div class="highlight"><pre><span></span><code><span class="c1">#exports</span>
<span class="k">def</span> <span class="nf">weighted_mean_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dt_rng</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2009-12-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">),</span> <span class="n">end_dt_delta_days</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the weighted average of a series&quot;&quot;&quot;</span>
    <span class="n">capture_prices</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">start_dt</span> <span class="ow">in</span> <span class="n">dt_rng</span><span class="p">:</span>
        <span class="n">end_dt</span> <span class="o">=</span> <span class="n">start_dt</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">end_dt_delta_days</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">s_weight</span><span class="p">[</span><span class="n">start_dt</span><span class="p">:</span><span class="n">end_dt</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights</span><span class="o">=</span><span class="kc">None</span>

        <span class="n">capture_prices</span><span class="p">[</span><span class="n">start_dt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">start_dt</span><span class="p">:</span><span class="n">end_dt</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

    <span class="n">s_capture_prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">capture_prices</span><span class="p">)</span>
    <span class="n">s_capture_prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">s_capture_prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s_capture_prices</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">s_wind_capture_prices</span> <span class="o">=</span> <span class="n">weighted_mean_s</span><span class="p">(</span><span class="n">s_dam</span><span class="p">,</span> <span class="n">s_wind</span><span class="p">)</span>
<span class="n">s_dam_prices</span> <span class="o">=</span> <span class="n">weighted_mean_s</span><span class="p">(</span><span class="n">s_dam</span><span class="p">)</span>

<span class="n">s_wind_capture_prices</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\pandas\core\indexes\base.py:5277: FutureWarning: Indexing a timezone-aware DatetimeIndex with a timezone-naive datetime is deprecated and will raise KeyError in a future version.  Use a timezone-aware object instead.
  start_slice, end_slice = self.slice_locs(start, end, step=step, kind=kind)





&lt;AxesSubplot:&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_88_2.png" /></p>
<p><br></p>
<p>We'll look at the distribution of the wind capture value ratio</p>
<div class="highlight"><pre><span></span><code><span class="n">s_wind_capture_value_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_wind_capture_prices</span> <span class="o">-</span> <span class="n">s_dam_prices</span><span class="p">)</span><span class="o">/</span><span class="n">s_dam_prices</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s_wind_capture_value_ratio</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">s_wind_capture_value_ratio</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>-0.028





&lt;AxesSubplot:ylabel=&#39;Count&#39;&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_90_2.png" /></p>
<p><br></p>
<p>We'll look at how this has changed on an annual basis</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="o">*</span><span class="n">s_wind_capture_value_ratio</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s_wind_capture_value_ratio</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Wind Capture Price Suppression (%)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0, 0.5, &#39;Wind Capture Price Suppression (%)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_92_1.png" /></p>
<p><br></p>
<p>It could be interesting to look at the effect of price suppression on specific wind farms that have CfDs, and then estimate the increased burden on the tax-payer.</p>
<p><br></p>
<h3 id="german-model">German Model<a class="headerlink" href="#german-model" title="Permanent link">&para;</a></h3>
<p>We'll now repeat the price MOE calculations for Germany, starting by loading in the relevant data</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">df_DE</span> <span class="o">=</span> <span class="n">eda</span><span class="o">.</span><span class="n">load_DE_df</span><span class="p">(</span><span class="s1">&#39;../data/raw/energy_charts.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;../data/raw/ENTSOE_DE_price.csv&#39;</span><span class="p">)</span>

<span class="n">df_DE</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 2.29 s
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Biomass</th>
      <th>Brown Coal</th>
      <th>Gas</th>
      <th>Hard Coal</th>
      <th>Hydro Power</th>
      <th>Oil</th>
      <th>Others</th>
      <th>Pumped Storage</th>
      <th>Seasonal Storage</th>
      <th>Solar</th>
      <th>Uranium</th>
      <th>Wind</th>
      <th>net_balance</th>
      <th>demand</th>
      <th>price</th>
    </tr>
    <tr>
      <th>local_datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2010-01-03 23:00:00+00:00</th>
      <td>3.637</td>
      <td>16.533</td>
      <td>4.726</td>
      <td>10.078</td>
      <td>2.331</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.052</td>
      <td>0.068</td>
      <td>0.0</td>
      <td>16.826</td>
      <td>0.635</td>
      <td>-1.229</td>
      <td>53.657</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2010-01-04 00:00:00+00:00</th>
      <td>3.637</td>
      <td>16.544</td>
      <td>4.856</td>
      <td>8.816</td>
      <td>2.293</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.038</td>
      <td>0.003</td>
      <td>0.0</td>
      <td>16.841</td>
      <td>0.528</td>
      <td>-1.593</td>
      <td>51.963</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2010-01-04 01:00:00+00:00</th>
      <td>3.637</td>
      <td>16.368</td>
      <td>5.275</td>
      <td>7.954</td>
      <td>2.299</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.032</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>16.846</td>
      <td>0.616</td>
      <td>-1.378</td>
      <td>51.649</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2010-01-04 02:00:00+00:00</th>
      <td>3.637</td>
      <td>15.837</td>
      <td>5.354</td>
      <td>7.681</td>
      <td>2.299</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>0.027</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>16.699</td>
      <td>0.630</td>
      <td>-1.624</td>
      <td>50.540</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2010-01-04 03:00:00+00:00</th>
      <td>3.637</td>
      <td>15.452</td>
      <td>5.918</td>
      <td>7.498</td>
      <td>2.301</td>
      <td>0.003</td>
      <td>0.0</td>
      <td>0.020</td>
      <td>0.000</td>
      <td>0.0</td>
      <td>16.635</td>
      <td>0.713</td>
      <td>-0.731</td>
      <td>51.446</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>

<p><br></p>
<p>We'll clean up the data and do a quick plot</p>
<div class="highlight"><pre><span></span><code><span class="n">df_DE_model</span> <span class="o">=</span> <span class="n">df_DE</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Solar&#39;</span><span class="p">,</span> <span class="s1">&#39;Wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">s_DE_price</span> <span class="o">=</span> <span class="n">df_DE_model</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
<span class="n">s_DE_demand</span> <span class="o">=</span> <span class="n">df_DE_model</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span>
<span class="n">s_DE_dispatchable</span> <span class="o">=</span> <span class="n">df_DE_model</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_DE_model</span><span class="p">[[</span><span class="s1">&#39;Solar&#39;</span><span class="p">,</span> <span class="s1">&#39;Wind&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_DE_dispatchable</span><span class="p">[</span><span class="s1">&#39;2015-03&#39;</span><span class="p">:</span><span class="s1">&#39;2015-09&#39;</span><span class="p">],</span> <span class="n">s_DE_price</span><span class="p">[</span><span class="s1">&#39;2015-03&#39;</span><span class="p">:</span><span class="s1">&#39;2015-09&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_DE_dispatchable</span><span class="p">[</span><span class="s1">&#39;2020-03&#39;</span><span class="p">:</span><span class="s1">&#39;2020-09&#39;</span><span class="p">],</span> <span class="n">s_DE_price</span><span class="p">[</span><span class="s1">&#39;2020-03&#39;</span><span class="p">:</span><span class="s1">&#39;2020-09&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Wind + Solar] (GW)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (EUR/MWh)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0, 0.5, &#39;Price (EUR/MWh)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_97_1.png" /></p>
<p><br></p>
<p>Let's create a visualisation that highlights the importance of regressing against dispatchable instead of total load</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">dt_min</span> <span class="o">=</span> <span class="s1">&#39;2020-10&#39;</span>
<span class="n">dt_max</span> <span class="o">=</span> <span class="s1">&#39;2020-12&#39;</span>

<span class="c1"># Dispatchable</span>
<span class="n">x_dispatch</span> <span class="o">=</span> <span class="n">s_DE_dispatchable</span><span class="p">[</span><span class="n">dt_min</span><span class="p">:</span><span class="n">dt_max</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_dispatch</span> <span class="o">=</span> <span class="n">s_DE_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_dispatchable</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="n">dt_min</span><span class="p">:</span><span class="n">dt_max</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">x_pred_dispatch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span>
<span class="n">y_pred_dispatch</span> <span class="o">=</span> <span class="n">lowess</span><span class="o">.</span><span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x_dispatch</span><span class="p">,</span> <span class="n">y_dispatch</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred_dispatch</span><span class="p">)</span>

<span class="c1"># Demand</span>
<span class="n">x_demand</span> <span class="o">=</span> <span class="n">s_DE_demand</span><span class="p">[</span><span class="n">dt_min</span><span class="p">:</span><span class="n">dt_max</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_demand</span> <span class="o">=</span> <span class="n">s_DE_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_dispatchable</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="n">dt_min</span><span class="p">:</span><span class="n">dt_max</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">x_pred_demand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
<span class="n">y_pred_demand</span> <span class="o">=</span> <span class="n">lowess</span><span class="o">.</span><span class="n">lowess_fit_and_predict</span><span class="p">(</span><span class="n">x_demand</span><span class="p">,</span> <span class="n">y_demand</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred_demand</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_pred_demand</span><span class="p">,</span> <span class="n">y_pred_demand</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_demand</span><span class="p">,</span> <span class="n">y_demand</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Demand (GW)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Day-Ahead Price (£/MWh)&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_pred_dispatch</span><span class="p">,</span> <span class="n">y_pred_dispatch</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_dispatch</span><span class="p">,</span> <span class="n">y_dispatch</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Solar + Wind] (GW)&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 236 ms
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_99_1.png" /></p>
<p><br></p>
<p>We'll load in our model</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="k">if</span> <span class="n">load_existing_DE_model</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">smooth_dates</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">DE_model_fp</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">reg_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;13W&#39;</span><span class="p">)</span>

    <span class="n">smooth_dates</span> <span class="o">=</span> <span class="n">lowess</span><span class="o">.</span><span class="n">SmoothDates</span><span class="p">()</span>
    <span class="n">smooth_dates</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">s_DE_dispatchable</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">s_DE_price</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dt_idx</span><span class="o">=</span><span class="n">s_DE_dispatchable</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                     <span class="n">reg_dates</span><span class="o">=</span><span class="n">reg_dates</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">num_fits</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">threshold_value</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>

    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">smooth_dates</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_fp</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 364 ms
</code></pre></div>
<p><br></p>
<p>Generate the regression surface prediction</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">951</span><span class="p">)</span>
<span class="n">dt_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span>

<span class="n">df_DE_pred</span> <span class="o">=</span> <span class="n">smooth_dates</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">dt_pred</span><span class="o">=</span><span class="n">dt_pred</span><span class="p">)</span>
<span class="n">df_DE_pred</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">df_DE_pred</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">df_DE_pred</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 276 ms
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2015-01-01</th>
      <th>2015-01-02</th>
      <th>2015-01-03</th>
      <th>2015-01-04</th>
      <th>2015-01-05</th>
      <th>2015-01-06</th>
      <th>2015-01-07</th>
      <th>2015-01-08</th>
      <th>2015-01-09</th>
      <th>2015-01-10</th>
      <th>...</th>
      <th>2020-12-22</th>
      <th>2020-12-23</th>
      <th>2020-12-24</th>
      <th>2020-12-25</th>
      <th>2020-12-26</th>
      <th>2020-12-27</th>
      <th>2020-12-28</th>
      <th>2020-12-29</th>
      <th>2020-12-30</th>
      <th>2020-12-31</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>-5.0</th>
      <td>-38.476089</td>
      <td>-38.424181</td>
      <td>-38.372664</td>
      <td>-38.321540</td>
      <td>-38.270810</td>
      <td>-38.220457</td>
      <td>-38.170466</td>
      <td>-38.120819</td>
      <td>-38.071502</td>
      <td>-38.022499</td>
      <td>...</td>
      <td>-48.264245</td>
      <td>-48.276583</td>
      <td>-48.289043</td>
      <td>-48.301630</td>
      <td>-48.314352</td>
      <td>-48.327214</td>
      <td>-48.340222</td>
      <td>-48.353377</td>
      <td>-48.366680</td>
      <td>-48.380130</td>
    </tr>
    <tr>
      <th>-4.9</th>
      <td>-38.316681</td>
      <td>-38.264928</td>
      <td>-38.213564</td>
      <td>-38.162593</td>
      <td>-38.112013</td>
      <td>-38.061811</td>
      <td>-38.011969</td>
      <td>-37.962470</td>
      <td>-37.913300</td>
      <td>-37.864444</td>
      <td>...</td>
      <td>-48.028460</td>
      <td>-48.040734</td>
      <td>-48.053130</td>
      <td>-48.065652</td>
      <td>-48.078308</td>
      <td>-48.091103</td>
      <td>-48.104044</td>
      <td>-48.117132</td>
      <td>-48.130367</td>
      <td>-48.143748</td>
    </tr>
    <tr>
      <th>-4.8</th>
      <td>-38.157233</td>
      <td>-38.105635</td>
      <td>-38.054425</td>
      <td>-38.003606</td>
      <td>-37.953178</td>
      <td>-37.903126</td>
      <td>-37.853434</td>
      <td>-37.804084</td>
      <td>-37.755061</td>
      <td>-37.706351</td>
      <td>...</td>
      <td>-47.792630</td>
      <td>-47.804841</td>
      <td>-47.817172</td>
      <td>-47.829629</td>
      <td>-47.842219</td>
      <td>-47.854948</td>
      <td>-47.867822</td>
      <td>-47.880842</td>
      <td>-47.894009</td>
      <td>-47.907321</td>
    </tr>
    <tr>
      <th>-4.7</th>
      <td>-37.997749</td>
      <td>-37.946306</td>
      <td>-37.895250</td>
      <td>-37.844584</td>
      <td>-37.794307</td>
      <td>-37.744406</td>
      <td>-37.694863</td>
      <td>-37.645661</td>
      <td>-37.596786</td>
      <td>-37.548223</td>
      <td>...</td>
      <td>-47.556765</td>
      <td>-47.568912</td>
      <td>-47.581178</td>
      <td>-47.593570</td>
      <td>-47.606094</td>
      <td>-47.618757</td>
      <td>-47.631564</td>
      <td>-47.644517</td>
      <td>-47.657615</td>
      <td>-47.670859</td>
    </tr>
    <tr>
      <th>-4.6</th>
      <td>-37.838231</td>
      <td>-37.786943</td>
      <td>-37.736041</td>
      <td>-37.685528</td>
      <td>-37.635403</td>
      <td>-37.585652</td>
      <td>-37.536258</td>
      <td>-37.487205</td>
      <td>-37.438478</td>
      <td>-37.390061</td>
      <td>...</td>
      <td>-47.320874</td>
      <td>-47.332956</td>
      <td>-47.345158</td>
      <td>-47.357485</td>
      <td>-47.369943</td>
      <td>-47.382539</td>
      <td>-47.395279</td>
      <td>-47.408164</td>
      <td>-47.421194</td>
      <td>-47.434369</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 2192 columns</p>
</div>

<p><br></p>
<p>As with the GB market you can see what is likely the effect of higher gas prices in 2018</p>
<div class="highlight"><pre><span></span><code><span class="n">df_DE_dispatchable_lims</span> <span class="o">=</span> <span class="n">construct_dispatchable_lims_df</span><span class="p">(</span><span class="n">s_DE_dispatchable</span><span class="p">,</span> <span class="n">rolling_w</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">df_DE_pred_mask</span> <span class="o">=</span> <span class="n">construct_pred_mask_df</span><span class="p">(</span><span class="n">df_DE_pred</span><span class="p">,</span> <span class="n">df_DE_dispatchable_lims</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">min_y</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">max_y</span> <span class="o">=</span> <span class="mi">70</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">htmp</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df_DE_pred</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_DE_pred_mask</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Price (EUR/MWh)&#39;</span><span class="p">})</span>

<span class="n">set_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">set_date_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1YS&#39;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">htmp</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Solar + Wind] (GW)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\sklearn\utils\validation.py:63: FutureWarning: Arrays of bytes/strings is being converted to decimal numbers if dtype=&#39;numeric&#39;. This behavior is deprecated in 0.24 and will be removed in 1.1 (renaming of 0.26). Please convert your data to numeric values explicitly instead.
  return f(*args, **kwargs)





Text(69.58333333333334, 0.5, &#39;Demand - [Solar + Wind] (GW)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_105_2.png" /></p>
<p><br></p>
<p>We'll calculate some metrics for our model</p>
<div class="highlight"><pre><span></span><code><span class="n">s_DE_pred_ts_dispatch</span><span class="p">,</span> <span class="n">s_DE_pred_ts_demand</span> <span class="o">=</span> <span class="n">get_model_pred_ts</span><span class="p">(</span><span class="n">s_DE_dispatchable</span><span class="p">,</span> <span class="n">DE_model_fp</span><span class="p">,</span> <span class="n">s_demand</span><span class="o">=</span><span class="n">s_DE_demand</span><span class="p">,</span> <span class="n">x_pred</span><span class="o">=</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">dt_pred</span><span class="o">=</span><span class="n">dt_pred</span><span class="p">)</span>

<span class="n">s_DE_dispatch_err</span> <span class="o">=</span> <span class="n">s_DE_pred_ts_dispatch</span> <span class="o">-</span> <span class="n">s_DE_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_pred_ts_dispatch</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">DE_dispatch_metrics</span> <span class="o">=</span> <span class="n">calc_error_metrics</span><span class="p">(</span><span class="n">s_DE_dispatch_err</span><span class="p">)</span>

<span class="n">s_DE_demand_err</span> <span class="o">=</span> <span class="n">s_DE_pred_ts_demand</span> <span class="o">-</span> <span class="n">s_DE_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_pred_ts_demand</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">DE_demand_metrics</span> <span class="o">=</span> <span class="n">calc_error_metrics</span><span class="p">(</span><span class="n">s_DE_demand_err</span><span class="p">)</span>

<span class="n">DE_dispatch_metrics</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>{&#39;median_abs_err&#39;: 4.257075090332123,
 &#39;mean_abs_err&#39;: 5.852023979176648,
 &#39;root_mean_square_error&#39;: 8.705711313706535}
</code></pre></div>
<p><br></p>
<p>As well as the <span class="arithmatex">\(r^{2}\)</span> score</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 0.733 for Halttunen2021</span>
<span class="n">r2_score</span><span class="p">(</span><span class="n">s_DE_price</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_pred_ts_dispatch</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">s_DE_pred_ts_dispatch</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.7244797152665161
</code></pre></div>
<p><br></p>
<p>We'll now calculate the total savings</p>
<div class="highlight"><pre><span></span><code><span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2015&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2020&#39;</span>

<span class="n">s_DE_MOE</span> <span class="o">=</span> <span class="n">s_DE_pred_ts_demand</span> <span class="o">-</span> <span class="n">s_DE_pred_ts_dispatch</span>
<span class="n">s_DE_MOE</span> <span class="o">=</span> <span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">s_DE_saving</span> <span class="o">=</span> <span class="n">s_DE_MOE</span> <span class="o">*</span> <span class="n">df_DE</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>
<span class="n">total_saving</span> <span class="o">=</span> <span class="n">s_DE_saving</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_date</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The total saving between </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2"> was £</span><span class="si">{</span><span class="n">total_saving</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>The total saving between 2015 and 2020 was £55,856,316,374
</code></pre></div>
<p><br></p>
<p>And get some context for the market average and total volumes over the same period</p>
<div class="highlight"><pre><span></span><code><span class="n">s_DE_mkt_cost</span> <span class="o">=</span> <span class="n">df_DE</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df_DE</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>

<span class="n">avg_DE_HH_mkt_cost</span> <span class="o">=</span> <span class="n">s_DE_mkt_cost</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">total_DE_mkt_cost</span> <span class="o">=</span> <span class="n">s_DE_mkt_cost</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_date</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">avg_DE_HH_mkt_cost</span><span class="p">,</span> <span class="n">total_DE_mkt_cost</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(2076614.8441243432, 109047198694.6575)
</code></pre></div>
<p><br></p>
<p>When we plot the percentage MOE over time we can see the large influence of lowered demand in 2020</p>
<div class="highlight"><pre><span></span><code><span class="n">s_DE_MOE_rolling</span> <span class="o">=</span> <span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">48</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">s_DE_DAM_rolling</span> <span class="o">=</span> <span class="n">df_DE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">48</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">s_DE_MOE_pct_reduction</span> <span class="o">=</span> <span class="n">s_DE_MOE_rolling</span><span class="o">/</span><span class="n">s_DE_DAM_rolling</span>

<span class="n">s_DE_MOE_pct_reduction</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;AxesSubplot:xlabel=&#39;local_datetime&#39;&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_115_1.png" /></p>
<p><br></p>
<p>We'll quickly calculate the average percentage price suppresion</p>
<div class="highlight"><pre><span></span><code><span class="n">s_DE_MOE</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_date</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">df_DE</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">s_DE_MOE</span><span class="p">)[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_date</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.3316044469891089
</code></pre></div>
<p><br></p>
<p>Of note there appeared to be relatively little impact on the MOE from the effects of the covid-19 response</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">s_DE_MOE</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_DE_MOE_rolling</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">s_DE_MOE_rolling</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;28-Day Average&#39;</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2015&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2021&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Merit Order Effect (EUR/MWh)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x22ccaf82700&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_119_1.png" /></p>
<p><br></p>
<p>Interestingly, the forecast made in 2011 by Traber et al as to the German MOE in 2020 was quite close.</p>
<blockquote>
<p>"In the absence of expanded deployment of renewable energy, a higher price increase of 20% can be expected" in 2020 - <a href="https://www.econstor.eu/handle/10419/57678">source</a></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">s_DE_MOE</span><span class="p">[</span><span class="s1">&#39;2015&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">s_DE_MOE</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(11.657604746082448, 22.174503965250132)
</code></pre></div>
<p><br></p>
<p>We'll now disaggregate the MOE based on the wind and solar drivers</p>
<div class="highlight"><pre><span></span><code><span class="n">wind_weight</span> <span class="o">=</span> <span class="n">df_DE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Wind&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df_DE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">][[</span><span class="s1">&#39;Wind&#39;</span><span class="p">,</span> <span class="s1">&#39;Solar&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">solar_weight</span> <span class="o">=</span> <span class="n">df_DE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Solar&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df_DE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">][[</span><span class="s1">&#39;Wind&#39;</span><span class="p">,</span> <span class="s1">&#39;Solar&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">s_wind_MOE</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_DE_MOE</span><span class="o">*</span><span class="n">wind_weight</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">s_solar_MOE</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_DE_MOE</span><span class="o">*</span><span class="n">solar_weight</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">s_wind_MOE</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">48</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Wind&#39;</span><span class="p">)</span>
<span class="n">s_solar_MOE</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">48</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Solar&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">55</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2015&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2021&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Merit Order Effect (EUR/MWh)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_123_0.png" /></p>
<p><br></p>
<p>We'll look at how the MOE has changed over time in terms of the seasonal effect</p>
<div class="highlight"><pre><span></span><code><span class="n">year_1</span> <span class="o">=</span> <span class="s1">&#39;2015&#39;</span>
<span class="n">year_2</span> <span class="o">=</span> <span class="s1">&#39;2020&#39;</span>

<span class="n">s_DE_DAM</span> <span class="o">=</span> <span class="n">df_DE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]</span>

<span class="n">month_num_to_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)))</span>

<span class="n">s_DE_hourly_dam_10</span> <span class="o">=</span> <span class="n">s_DE_DAM</span><span class="p">[</span><span class="n">year_1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s_DE_DAM</span><span class="p">[</span><span class="n">year_1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">s_DE_hourly_MOE_10</span> <span class="o">=</span> <span class="n">s_DE_MOE</span><span class="p">[</span><span class="n">year_1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s_DE_MOE</span><span class="p">[</span><span class="n">year_1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">s_DE_hourly_dam_20</span> <span class="o">=</span> <span class="n">s_DE_DAM</span><span class="p">[</span><span class="n">year_2</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s_DE_DAM</span><span class="p">[</span><span class="n">year_2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">s_DE_hourly_MOE_20</span> <span class="o">=</span> <span class="n">s_DE_MOE</span><span class="p">[</span><span class="n">year_2</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s_DE_MOE</span><span class="p">[</span><span class="n">year_2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s_DE_hourly_dam_10</span><span class="p">,</span> <span class="n">s_DE_hourly_MOE_10</span><span class="p">,</span> <span class="n">s_DE_hourly_dam_20</span><span class="p">,</span> <span class="n">s_DE_hourly_MOE_20</span><span class="p">]:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">month_num_to_name</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="p">(</span><span class="n">s_DE_hourly_dam_10</span><span class="o">+</span><span class="n">s_DE_hourly_MOE_10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MOE&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">s_DE_hourly_dam_10</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="p">(</span><span class="n">s_DE_hourly_dam_20</span><span class="o">+</span><span class="n">s_DE_hourly_MOE_20</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MOE&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">s_DE_hourly_dam_20</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Day-Ahead&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">year_1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">year_2</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">positions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (EUR/MWh)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Text(0, 0.5, &#39;Price (EUR/MWh)&#39;)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_125_1.png" /></p>
<p><br></p>
<p>We'll also inspect the predictions on a sample day</p>
<div class="highlight"><pre><span></span><code><span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;2020-04-11&#39;</span>

<span class="c1"># Plotting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="n">s_DE_pred_ts_dispatch</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction with RES&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">s_DE_pred_ts_demand</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction without RES&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">s_DE_price</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.075</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price (EUR/MWh)&#39;</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_127_0.png" /></p>
<p><br></p>
<p>There's clearly a correlation between the annual MOE average and the RES percentage penetration</p>
<div class="highlight"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>

<span class="n">s_DE_MOE_annual_avg</span> <span class="o">=</span> <span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">s_DE_RES_pct_annual_avg</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">df_DE</span><span class="p">[[</span><span class="s1">&#39;Wind&#39;</span><span class="p">,</span> <span class="s1">&#39;Solar&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">df_DE</span><span class="p">[</span><span class="s1">&#39;demand&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2015</span><span class="p">:]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_DE_MOE_annual_avg</span><span class="p">,</span> <span class="n">s_DE_RES_pct_annual_avg</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Wall time: 51 ms





&lt;matplotlib.collections.PathCollection at 0x22c405d2dc0&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_129_2.png" /></p>
<p><br></p>
<p>We'll quickly calculate the gradient</p>
<div class="highlight"><pre><span></span><code><span class="n">linreg_results</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">s_DE_RES_pct_annual_avg</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">s_DE_MOE_annual_avg</span><span class="p">)</span>

<span class="n">linreg_results</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>LinregressResult(slope=0.7365449501368756, intercept=-3.832555184231513, rvalue=0.9793888213890273, pvalue=0.0006328529981050964, stderr=0.07595057880689415, intercept_stderr=2.196641338586976)
</code></pre></div>
<p><br></p>
<p>We'll get some context from the literature</p>
<div class="highlight"><pre><span></span><code><span class="n">imperial_paper_slope</span> <span class="o">=</span> <span class="mf">0.63</span>

<span class="n">pct_diff</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">linreg_results</span><span class="o">.</span><span class="n">slope</span><span class="o">-</span><span class="n">imperial_paper_slope</span><span class="p">)</span><span class="o">/</span><span class="n">imperial_paper_slope</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;In this work the MOE increase per percentage penetration of RES was </span><span class="si">{</span><span class="n">pct_diff</span><span class="si">}</span><span class="s1">% higher (for Germany) than the Imperial study&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>In this work the MOE increase per percentage penetration of RES was 17% higher (for Germany) than the Imperial study
</code></pre></div>
<p><br></p>
<h3 id="plots">Plots<a class="headerlink" href="#plots" title="Permanent link">&para;</a></h3>
<p>In this section we'll generate some of the plots needed for the paper, starting with the heatmap of the price surfaces</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># GB</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">min_y</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">max_y</span> <span class="o">=</span> <span class="mi">60</span>

<span class="n">htmp</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df_pred</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_pred_mask</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Half-Hourly CO2 Emissions (Tonnes)&#39;</span><span class="p">})</span>

<span class="n">set_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">set_date_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1YS&#39;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">htmp</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Solar + Wind] (GW)&#39;</span><span class="p">)</span>

<span class="c1"># DE</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">min_y</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">max_y</span> <span class="o">=</span> <span class="mi">80</span>

<span class="n">htmp</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df_DE_pred</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_DE_pred_mask</span><span class="p">[</span><span class="n">min_y</span><span class="p">:</span><span class="n">max_y</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Hourly CO2 Emissions (Tonnes)&#39;</span><span class="p">})</span>

<span class="n">set_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">set_date_ticks</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1YS&#39;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">htmp</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Demand - [Solar + Wind] (GW)&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\sklearn\utils\validation.py:63: FutureWarning: Arrays of bytes/strings is being converted to decimal numbers if dtype=&#39;numeric&#39;. This behavior is deprecated in 0.24 and will be removed in 1.1 (renaming of 0.26). Please convert your data to numeric values explicitly instead.
  return f(*args, **kwargs)
C:\Users\Ayrto\anaconda3\envs\MOE\lib\site-packages\sklearn\utils\validation.py:63: FutureWarning: Arrays of bytes/strings is being converted to decimal numbers if dtype=&#39;numeric&#39;. This behavior is deprecated in 0.24 and will be removed in 1.1 (renaming of 0.26). Please convert your data to numeric values explicitly instead.
  return f(*args, **kwargs)
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_135_1.png" /></p>
<p><br></p>
<p>We'll also plot the MOE time-series</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># GB</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_GB_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">s_GB_MOE</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">s_GB_MOE_rolling</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;28-Day Average&#39;</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2010&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2021&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Merit Order Effect (£/MWh)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># DE</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">s_DE_MOE</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">s_DE_MOE</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_DE_MOE_rolling</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">s_DE_MOE_rolling</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;28-Day Average&#39;</span><span class="p">)</span>

<span class="n">eda</span><span class="o">.</span><span class="n">hide_spines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2015&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2021&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Merit Order Effect (EUR/MWh)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x22c22be1040&gt;
</code></pre></div>
<p><img alt="png" src="../img/nbs/output_137_1.png" /></p>
<p><br></p>
<h3 id="saving-results">Saving Results<a class="headerlink" href="#saving-results" title="Permanent link">&para;</a></h3>
<p>Additionaly we'll save the time-series predictions and model metrics, starting with the GB time-series</p>
<div class="highlight"><pre><span></span><code><span class="n">df_GB_results_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">s_GB_pred_ts_dispatch</span><span class="p">,</span>
    <span class="s1">&#39;counterfactual&#39;</span><span class="p">:</span> <span class="n">s_GB_pred_ts_demand</span><span class="p">,</span>
    <span class="s1">&#39;observed&#39;</span><span class="p">:</span> <span class="n">s_GB_price</span><span class="p">,</span>
    <span class="s1">&#39;moe&#39;</span><span class="p">:</span> <span class="n">s_GB_MOE</span>
<span class="p">})</span>

<span class="n">df_GB_results_ts</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prediction</th>
      <th>counterfactual</th>
      <th>observed</th>
      <th>moe</th>
    </tr>
    <tr>
      <th>local_datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2009-01-01 00:00:00+00:00</th>
      <td>37.203441</td>
      <td>37.313379</td>
      <td>58.05</td>
      <td>0.109938</td>
    </tr>
    <tr>
      <th>2009-01-01 00:30:00+00:00</th>
      <td>37.313379</td>
      <td>37.535135</td>
      <td>56.33</td>
      <td>0.221756</td>
    </tr>
    <tr>
      <th>2009-01-01 01:00:00+00:00</th>
      <td>36.768513</td>
      <td>36.985087</td>
      <td>52.98</td>
      <td>0.216574</td>
    </tr>
    <tr>
      <th>2009-01-01 01:30:00+00:00</th>
      <td>35.595162</td>
      <td>35.807631</td>
      <td>50.39</td>
      <td>0.212469</td>
    </tr>
    <tr>
      <th>2009-01-01 02:00:00+00:00</th>
      <td>34.849422</td>
      <td>35.063119</td>
      <td>48.70</td>
      <td>0.213697</td>
    </tr>
  </tbody>
</table>
</div>

<p><br></p>
<p>Which we'll save to csv</p>
<div class="highlight"><pre><span></span><code><span class="n">df_GB_results_ts</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/results/GB_price.csv&#39;</span><span class="p">)</span>
</code></pre></div>
<p><br></p>
<p>Then the DE time-series</p>
<div class="highlight"><pre><span></span><code><span class="n">df_DE_results_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">s_DE_pred_ts_dispatch</span><span class="p">,</span>
    <span class="s1">&#39;counterfactual&#39;</span><span class="p">:</span> <span class="n">s_DE_pred_ts_demand</span><span class="p">,</span>
    <span class="s1">&#39;observed&#39;</span><span class="p">:</span> <span class="n">s_DE_price</span><span class="p">,</span>
    <span class="s1">&#39;moe&#39;</span><span class="p">:</span> <span class="n">s_DE_MOE</span>
<span class="p">})</span>

<span class="n">df_DE_results_ts</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/results/DE_price.csv&#39;</span><span class="p">)</span>

<span class="n">df_DE_results_ts</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>prediction</th>
      <th>counterfactual</th>
      <th>observed</th>
      <th>moe</th>
    </tr>
    <tr>
      <th>local_datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-04 23:00:00+00:00</th>
      <td>24.496292</td>
      <td>34.530421</td>
      <td>22.34</td>
      <td>10.034130</td>
    </tr>
    <tr>
      <th>2015-01-05 00:00:00+00:00</th>
      <td>23.758428</td>
      <td>33.626015</td>
      <td>17.93</td>
      <td>9.867587</td>
    </tr>
    <tr>
      <th>2015-01-05 01:00:00+00:00</th>
      <td>23.662602</td>
      <td>33.924488</td>
      <td>15.17</td>
      <td>10.261886</td>
    </tr>
    <tr>
      <th>2015-01-05 02:00:00+00:00</th>
      <td>24.134178</td>
      <td>34.531475</td>
      <td>16.38</td>
      <td>10.397297</td>
    </tr>
    <tr>
      <th>2015-01-05 03:00:00+00:00</th>
      <td>24.934345</td>
      <td>36.210384</td>
      <td>17.38</td>
      <td>11.276039</td>
    </tr>
  </tbody>
</table>
</div>

<p><br></p>
<p>And finally the model metrics for both</p>
<div class="highlight"><pre><span></span><code><span class="n">model_accuracy_metrics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DE_dispatch&#39;</span><span class="p">:</span> <span class="n">DE_dispatch_metrics</span><span class="p">,</span>
    <span class="s1">&#39;DE_demand&#39;</span><span class="p">:</span> <span class="n">DE_demand_metrics</span><span class="p">,</span>
    <span class="s1">&#39;GB_dispatch&#39;</span><span class="p">:</span> <span class="n">GB_dispatch_metrics</span><span class="p">,</span>
    <span class="s1">&#39;GB_demand&#39;</span><span class="p">:</span> <span class="n">GB_demand_metrics</span>
<span class="p">}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../data/results/price_model_accuracy_metrics.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_accuracy_metrics</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

<span class="n">JSON</span><span class="p">(</span><span class="n">model_accuracy_metrics</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;IPython.core.display.JSON object&gt;
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../dev-04-price-surface-estimation/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Price Curve Estimation
              </div>
            </div>
          </a>
        
        
          <a href="../dev-06-carbon-surface-estimation-and-moe/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Carbon Curve Estimation & MOE
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.08c56446.min.js"></script>
      <script src="../assets/javascripts/bundle.6ced434e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ['header.autohide', 'navigation.tabs', 'navigation.instant', 'search.suggest'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML-full,Safe&amp;delayStartupUntil=configured"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/config/TeX-AMS-MML_HTMLorMML-full.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/config/Safe.js?V=2.7.9"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/extensions/Safe.js?V=2.7.9"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/jax/output/HTML-CSS/fonts/STIX-Web/fontdata.js?V=2.7.9"></script>
      
    
  </body>
</html>